<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoneyWise</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Playfair+Display:wght@400;700&family=Merriweather:wght@300;400;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
    }
  
    .dropdown-item {
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
    }

body {
  background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 100%) !important;
}

.dark body {
  background: linear-gradient(135deg, #292524 0%, #44403c 100%) !important;
}

.quote-container {
  background: linear-gradient(135deg, #fefaf6 0%, #f9f6f2 100%);
  border-left: 6px solid #a78b71;
}
.dark .quote-container {
  background: linear-gradient(135deg, #3a3630 0%, #2d2a26 100%);
  border-left: 6px solid #b49b83;
}

.hover-lift:hover {
  transform: translateY(-4px);
  box-shadow: 0 20px 40px -10px rgba(120, 113, 108, 0.15);
}

nav.bg-white {
  background: linear-gradient(135deg, #ffffff 0%, #fafaf9 100%) !important;
}
.dark nav.dark\:bg-gray-800 {
  background: linear-gradient(135deg, #292524 0%, #1c1917 100%) !important;
}

.bg-gradient-to-r.from-blue-50.to-indigo-50 {
  background: linear-gradient(135deg, #f7f7f5 0%, #f0f0ed 100%);
}
.dark .bg-gradient-to-r.from-blue-50.to-indigo-50 {
  background: linear-gradient(135deg, #3a3630 0%, #2d2a26 100%);
}

.bg-gradient-to-r.from-green-50.to-emerald-50 {
  background: linear-gradient(135deg, #f0f2eb 0%, #e8ebe5 100%);
}
.dark .bg-gradient-to-r.from-green-50.to-emerald-50 {
  background: linear-gradient(135deg, #6f706f 0%, #9f9f9f 100%);
}

.bg-gradient-to-r.from-red-50.to-pink-50 {
  background: linear-gradient(135deg, #f8f0ef 0%, #f2e8e7 100%);
}
.dark .bg-gradient-to-r.from-red-50.to-pink-50 {
  background: linear-gradient(135deg, #3a2d2d 0%, #322626 100%);
}

.bg-gradient-to-r.from-purple-50.to-violet-50 {
  background: linear-gradient(135deg, #f5f2f0 0%, #f0edea 100%);
}
.dark .bg-gradient-to-r.from-purple-50.to-violet-50 {
  background: linear-gradient(135deg, #3a3030 0%, #322d2d 100%);
}

.bg-gradient-to-r.from-emerald-50.to-teal-50 {
  background: linear-gradient(135deg, #f0f2eb 0%, #e8ebe8 100%);
}
.dark .bg-gradient-to-r.from-emerald-50.to-teal-50 {
  background: linear-gradient(135deg, #2d3a2a 0%, #2d3232 100%);
}

.bg-gray-50 {
  background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 100%) !important;
}
.dark .bg-gray-50 {
  background: linear-gradient(135deg, #3a3630 0%, #2d2a26 100%) !important;
}
.bg-gradient-to-r.from-blue-50.to-purple-50 {
  background: linear-gradient(135deg, #f7f7f5 0%, #f5f2f0 100%);
}
.dark .bg-gradient-to-r.from-blue-50.to-purple-50 {
  background: linear-gradient(135deg, #3a3630 0%, #3a3030 100%);
}
.bg-gradient-to-br.from-blue-50.to-cyan-50 {
  background: linear-gradient(135deg, #f7f7f5 0%, #f5f7f7 100%);
}
.dark .bg-gradient-to-br.from-blue-50.to-cyan-50 {
  background: linear-gradient(135deg, #3a3630 0%, #303a3a 100%);
}

.bg-gradient-to-br.from-red-50.to-pink-50 {
  background: linear-gradient(135deg, #f8f0ef 0%, #f8f2f0 100%);
}
.dark .bg-gradient-to-br.from-red-50.to-pink-50 {
  background: linear-gradient(135deg, #3a2d2d 0%, #3a3030 100%);
}

.bg-gradient-to-br.from-purple-50.to-violet-50 {
  background: linear-gradient(135deg, #f5f2f0 0%, #f5f0f2 100%);
}
.dark .bg-gradient-to-br.from-purple-50.to-violet-50 {
  background: linear-gradient(135deg, #3a3030 0%, #3a2d3a 100%);
}

.bg-white {
  background: #ffffff !important;
}
.dark .bg-gray-800 {
  background: #2d2a26 !important;
}

.income-input, 
input, 
select, 
textarea {
  background-color: #fefaf6 !important;
  border-color: #e7e5e4 !important;
}
.dark .income-input,
.dark input,
.dark select,
.dark textarea {
  background-color: #3a3630 !important;
  border-color: #57534e !important;
}

.bg-blue-500 {
  background-color: #8b7d6b !important;
}
.bg-blue-500:hover {
  background-color: #756a5b !important;
}

.bg-green-500 {
  background-color: #7d8b6b !important;
}
.bg-green-500:hover {
  background-color: #6a755b !important;
}

.bg-purple-500 {
  background-color: #8b6b7d !important;
}
.bg-purple-500:hover {
  background-color: #755b6a !important;
}


.quote-icon {
  color: #d6d3d1;
}
.dark .quote-icon {
  color: #57534e;
}

.bg-green-100 {
  background-color: #f0f2eb !important;
}
.bg-yellow-100 {
  background-color: #f8f2eb !important;
}
.bg-red-100 {
  background-color: #f8efeb !important;
}

.text-green-600 {
  color: #6a755b !important;
}
.text-red-600 {
  color: #755b5b !important;
}
.text-blue-600 {
  color: #5b6a75 !important;
}
.text-purple-600 {
  color: #755b6a !important;
}
    .dropdown-menu {
      display: none;
      position: fixed;
      right: 16px;
      top: 70px;
      background: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border-radius: 12px;
      z-index: 9999;
      min-width: 220px;
      overflow: hidden;
    }
    
    .dark .dropdown-menu {
      background: #1f2937;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    
    .dropdown-menu.show {
      display: block;
    }
    
    .dropdown-item {
      display: flex;
      align-items: center;
      padding: 0.875rem 1rem;
      width: 100%;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.9375rem;
      transition: all 0.2s ease;
    }
    
    .dark .dropdown-item {
      border-color: #4b5563;
    }
    
    .dropdown-item:hover {
      background-color: #f3f4f6;
      transform: translateX(2px);
    }
    
    .dark .dropdown-item:hover {
      background-color: #374151;
    }
    
    .dropdown-item i {
      width: 20px;
      margin-right: 10px;
      text-align: center;
    }
    
    .quote-text {
      font-family: 'Crimson Text', serif;
      font-style: italic;
      font-size: 1.25rem;
      line-height: 1.6;
    }
    .quote-author {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .quote-container {
      background: linear-gradient(135deg, #f5f3ff 0%, #e6c4c4 100%);
      border-left: 6px solid #2f130d;
      position: relative;
      overflow: hidden;
    }
    .dark .quote-container {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      border-left: 6px solid #ce947b;
    }
    .quote-icon {
      position: absolute;
      opacity: 0.1;
      font-size: 8rem;
      right: 20px;
      top: 20px;
      transform: rotate(15deg);
    }
    .quote-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #c4b5fd;
      transition: all 0.3s ease;
    }
    .quote-indicator.active {
      background-color: #8b5cf6;
      transform: scale(1.2);
    }
    .fade-in {
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInFromTop {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-in {
      animation: slideInFromTop 0.3s ease-out;
    }
    
    @keyframes slideInFromLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(193, 211, 239, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
    }
    
    .hover-lift {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .shimmer-animation {
      animation: shimmer 2s infinite;
    }
    
    button, input, select {
      transition: all 0.2s ease;
    }
    
    button:hover {
      transition: all 0.2s ease;
    }
    
    .income-input {
      transition: all 0.3s ease;
    }
    .income-input:focus {
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
      border-color: #8b5cf6;
    }
    canvas { max-height: 300px; }
  </style>
</head>
<body class="bg-stone-50 text-gray-800 dark:bg-stone-900 dark:text-gray-100 transition-colors">
  <div id="root"></div>

  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script type="text/babel" data-presets="es2017,react">
    const { useState, useEffect } = React;

    // Money quotes array
    const moneyQuotes = [
      {
        text: "Money is multiplied in practical value depending on the number of W's you control in your life: what you do, when you do it, where you do it and with whom you do it. I call this the 'freedom multiplier.'",
        author: "Timothy Ferriss"
      },
      {
        text: "If you don't find a way to make money while you sleep, you will work until you die.",
        author: "Warren Buffett"
      },
      {
        text: "Financial freedom is available to those who learn about it and work for it.",
        author: "Robert Kiyosaki"
      },
      {
        text: "Making money is a hobby that will complement any other hobbies you have, beautifully.",
        author: "Scott Alexander"
      },
      {
        text: "Making money is easy. It is. The difficult thing in life is not making it, it's keeping it.",
        author: "John McAfee"
      },
      {
        text: "The time making money should be greater than the time that you are spending money.",
        author: "Sophia Amoruso"
      },
      {
        text: "Financial peace isn't the acquisition of stuff. It's learning to live on less than you make, so you can give money back and have money to invest. You can't win until you do this.",
        author: "Dave Ramsey"
      },
      {
        text: "A penny saved is a penny earned.",
        author: "Benjamin Franklin"
      },
      {
        text: "The quickest way to double your money is to fold it in half and put it in your back pocket.",
        author: "Will Rogers"
      },
      {
        text: "It's good to have money and the things that money can buy, but it's good, too, to check up once in a while",
        author: "George Horace Lorimer"
      },
      {
        text: "If you think nobody cares if you're alive, try missing a couple of car payments.",
        author: "Earl Wilson"
      },
      {
        text: "My father had an expression: Don't tell me what you value, show me your budget, and I'll tell you what you value.",
        author: "Joe Biden"
      },
      {
        text: "Buy when everyone else is selling and hold until everyone else is buying. That's not just a catchy slogan. It's the very essence of successful investing.",
        author: "J. Paul Getty"
      },
      {
        text: "Do not save what is left after spending; instead, spend what is left after saving.",
        author: "Warren Buffett"
      },
      {
        text: "While money can't buy happiness, it certainly lets you choose your own form of misery.",
        author: "Groucho Marx"
      }
    ];

    function App({ currentUser, logoutUser }) {
      const [customIncome, setCustomIncome] = useState(() => {
        const saved = localStorage.getItem("customIncome");
        return saved ? parseFloat(saved) : 0;
      });
      const [transactions, setTransactions] = useState(() => {
        const saved = localStorage.getItem("transactions");
        return saved ? JSON.parse(saved) : [];
      });
      const [darkMode, setDarkMode] = useState(() => localStorage.getItem("theme") === "dark");
      const [budgets, setBudgets] = useState(() => {
        const saved = localStorage.getItem("budgets");
        return saved ? JSON.parse(saved) : {};
      });
      const [personSettlements, setPersonSettlements] = useState(() => {
        const saved = localStorage.getItem("personSettlements");
        return saved ? JSON.parse(saved) : [];
      });
      const [autoBudgetSuggestions, setAutoBudgetSuggestions] = useState(() => {
        const saved = localStorage.getItem("autoBudgetSuggestions");
        return saved ? JSON.parse(saved) : {};
      });
      const [monthlyTrends, setMonthlyTrends] = useState(() => {
        const saved = localStorage.getItem("monthlyTrends");
        return saved ? JSON.parse(saved) : {};
      });
      const [personList, setPersonList] = useState(() => {
        const saved = localStorage.getItem("personList");
        return saved ? JSON.parse(saved) : ["Friend 1", "Friend 2", "Roommate", "Family Member"];
      });
      const [transactionMonthFilter, setTransactionMonthFilter] = useState("all");
      const [currentQuoteIndex, setCurrentQuoteIndex] = useState(0);
      const [showDropdown, setShowDropdown] = useState(false);
      const [activeView, setActiveView] = useState("home");
      const [selectedMonth, setSelectedMonth] = useState(() => {
        const currentMonth = new Date().toISOString().slice(0, 7);
        return localStorage.getItem("selectedMonth") || currentMonth;
      });
      const [editingTransaction, setEditingTransaction] = useState(null);
      const [showInsights, setShowInsights] = useState(false);

      useEffect(() => {
        localStorage.setItem("customIncome", customIncome.toString());
        localStorage.setItem("transactions", JSON.stringify(transactions));
        localStorage.setItem("budgets", JSON.stringify(budgets));
        localStorage.setItem("personSettlements", JSON.stringify(personSettlements));
        localStorage.setItem("autoBudgetSuggestions", JSON.stringify(autoBudgetSuggestions));
        localStorage.setItem("monthlyTrends", JSON.stringify(monthlyTrends));
        localStorage.setItem("personList", JSON.stringify(personList));
        localStorage.setItem("selectedMonth", selectedMonth);
      }, [customIncome, transactions, budgets, personSettlements, autoBudgetSuggestions, monthlyTrends, personList, selectedMonth]);

      useEffect(() => {
        document.documentElement.classList.toggle("dark", darkMode);
        localStorage.setItem("theme", darkMode ? "dark" : "light");
      }, [darkMode]);

      useEffect(() => {
        const randomIndex = Math.floor(Math.random() * moneyQuotes.length);
        setCurrentQuoteIndex(randomIndex);
        
        const quoteInterval = setInterval(() => {
          setCurrentQuoteIndex(prevIndex => {
            let nextIndex;
            do {
              nextIndex = Math.floor(Math.random() * moneyQuotes.length);
            } while (nextIndex === prevIndex && moneyQuotes.length > 1);
            return nextIndex;
          });
        }, 10000);
        
        return () => clearInterval(quoteInterval);
      }, []);

      useEffect(() => {
        const calculateMonthlyTrends = () => {
          const trends = {};
          const monthlyData = {};
          
          transactions.forEach(tx => {
            if (tx.category.toLowerCase() !== "income") {
              const date = new Date(tx.date);
              const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
              
              if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = {};
              }
              
              if (!monthlyData[monthYear][tx.category]) {
                monthlyData[monthYear][tx.category] = 0;
              }
              
              monthlyData[monthYear][tx.category] += tx.amount;
            }
          });

          Object.keys(monthlyData).sort().forEach(month => {
            Object.keys(monthlyData[month]).forEach(category => {
              if (!trends[category]) {
                trends[category] = [];
              }
              trends[category].push({
                month,
                amount: monthlyData[month][category]
              });
            });
          });

          setMonthlyTrends(trends);
        };

        const calculateAutoBudget = () => {
          const categoryTotals = {};
          const categoryCounts = {};
          
          transactions.forEach(tx => {
            if (tx.category.toLowerCase() !== "income") {
              categoryTotals[tx.category] = (categoryTotals[tx.category] || 0) + tx.amount;
              categoryCounts[tx.category] = (categoryCounts[tx.category] || 0) + 1;
            }
          });

          const suggestions = {};
          Object.keys(categoryTotals).forEach(category => {
            const avgSpending = categoryTotals[category] / Math.max(categoryCounts[category], 1);
            suggestions[category] = Math.round(avgSpending * 1.1);
          });

          setAutoBudgetSuggestions(suggestions);
        };

        calculateMonthlyTrends();
        calculateAutoBudget();
      }, [transactions]);

      const filterByMonth = (data, dateField) => {
        if (!data || !Array.isArray(data)) return [];
        if (selectedMonth === "all") return data;
        
        return data.filter(item => {
          if (!item[dateField]) return false;
          const itemDate = new Date(item[dateField]);
          const itemMonth = `${itemDate.getFullYear()}-${(itemDate.getMonth() + 1).toString().padStart(2, '0')}`;
          return itemMonth === selectedMonth;
        });
      };

      const getCurrentBudgets = () => {
        const monthKey = selectedMonth === "all" ? "default" : selectedMonth;
        return budgets[monthKey] || {};
      };

      function addTransaction(tx) {
        const txWithId = {
          ...tx,
          id: Date.now() + Math.random(),
          createdAt: new Date().toISOString()
        };
        
        if (tx.groupPay === "Yes" && tx.groupDetails && tx.groupDetails.people && tx.groupDetails.people.length > 0) {
          const totalPeople = tx.groupDetails.people.length;
          const totalAmount = tx.amount;
          
          tx.groupDetails.people.forEach(person => {
            if (!person.includeMe) {
              const newSettlement = {
                id: Date.now() + Math.random(),
                description: tx.description,
                date: tx.date,
                totalAmount: totalAmount,
                perPersonAmount: person.amount,
                numPeople: totalPeople,
                paidBy: currentUser,
                personName: person.name,
                paid: false,
                category: tx.category,
                transactionId: Date.now()
              };
              setPersonSettlements(prev => [...prev, newSettlement]);
            }
          });
        }
        setTransactions([...transactions, txWithId]);
      }

      function editTransaction(updatedTx) {
        const newTransactions = [...transactions];
        const index = newTransactions.findIndex(tx => tx.id === updatedTx.id);
        if (index !== -1) {
          newTransactions[index] = updatedTx;
          setTransactions(newTransactions);
          setEditingTransaction(null);
        }
      }

      function deleteTransaction(index) {
        const txToDelete = transactions[index];
        
        if (txToDelete.groupPay === "Yes") {
          setPersonSettlements(prev => 
            prev.filter(settlement => !settlement.description.includes(txToDelete.description))
          );
        }
        
        const newTx = [...transactions];
        newTx.splice(index, 1);
        setTransactions(newTx);
      }

      function exportToCSV() {
        const monthTransactions = selectedMonth === "all" 
          ? transactions 
          : filterByMonth(transactions, 'date');
        
        let csv = `Month: ${selectedMonth}\n\n`;
        csv += "Date,Description,Category,Amount,Group Pay,Necessity,Number of People,Total People,Persons Involved,Amount Per Person\n";
        
        monthTransactions.forEach(tx => {
          if (tx.groupPay === "Yes" && tx.groupDetails) {
            const peopleList = tx.groupDetails.people.map(p => p.name).join(';');
            const amountsList = tx.groupDetails.people.map(p => p.amount.toFixed(2)).join(';');
            csv += `${tx.date},${tx.description},${tx.category},${tx.amount},${tx.groupPay},${tx.necessity},${tx.groupDetails.people.length},${tx.groupDetails.totalPeople || tx.groupDetails.people.length},${peopleList},${amountsList}\n`;
          } else {
            csv += `${tx.date},${tx.description},${tx.category},${tx.amount},${tx.groupPay},${tx.necessity},1,1,${currentUser},${tx.amount}\n`;
          }
        });
        
        csv += "\n\nBUDGET SUMMARY\n";
        csv += "Category,Budget Set,Amount Spent,Remaining,Percentage Used\n";
        
        const categories = [...new Set(monthTransactions.map(t => t.category))].filter(cat => cat.toLowerCase() !== "income");
        const currentBudgets = getCurrentBudgets();
        
        categories.forEach(cat => {
          const spent = monthTransactions.filter(t => t.category === cat).reduce((sum, t) => sum + t.amount, 0);
          const budget = currentBudgets[cat] || 0;
          const remaining = budget - spent;
          const percentageUsed = budget > 0 ? (spent / budget * 100).toFixed(2) : 0;
          csv += `${cat},${budget},${spent.toFixed(2)},${remaining.toFixed(2)},${percentageUsed}%\n`;
        });
        
        csv += "\n\nNEEDS VS WANTS SUMMARY\n";
        const needsTotal = monthTransactions.filter(tx => tx.necessity === "Needs").reduce((sum, tx) => sum + tx.amount, 0);
        const wantsTotal = monthTransactions.filter(tx => tx.necessity === "Wants").reduce((sum, tx) => sum + tx.amount, 0);
        const investmentTotal = monthTransactions.filter(tx => tx.necessity === "Investment").reduce((sum, tx) => sum + tx.amount, 0);
        csv += `Needs Total:,${needsTotal.toFixed(2)}\n`;
        csv += `Wants Total:,${wantsTotal.toFixed(2)}\n`;
        csv += `Investment Total:,${investmentTotal.toFixed(2)}\n`;
        csv += `Total Expenses:,${(needsTotal + wantsTotal + investmentTotal).toFixed(2)}\n`;
        
        csv += "\n\nMONTHLY TRENDS\n";
        csv += "Category,Month,Amount\n";
        Object.keys(monthlyTrends).forEach(category => {
          monthlyTrends[category].forEach(trend => {
            csv += `${category},${trend.month},${trend.amount.toFixed(2)}\n`;
          });
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        window.saveAs(blob, `moneywise_report_${selectedMonth}.csv`);
      }

      const calculatedIncome = transactions
        .filter(tx => tx.category.toLowerCase() === "income")
        .reduce((acc, tx) => acc + tx.amount, 0);
      
      const totalIncome = customIncome + calculatedIncome;

      const totalExpenses = transactions
        .filter(tx => tx.category.toLowerCase() !== "income")
        .reduce((acc, tx) => acc + tx.amount, 0);

      const moneyOwedToYou = personSettlements
        .filter(settlement => !settlement.paid)
        .reduce((acc, settlement) => acc + settlement.perPersonAmount, 0);
      
      const remainingIncome = totalIncome - totalExpenses + moneyOwedToYou;

      function updateBudget(category, amount) {
        const monthKey = selectedMonth === "all" ? "default" : selectedMonth;
        const updatedBudgets = { 
          ...budgets, 
          [monthKey]: {
            ...(budgets[monthKey] || {}),
            [category]: parseFloat(amount) || 0
          }
        };
        setBudgets(updatedBudgets);
      }

      function markAsPaid(id) {
        setPersonSettlements(personSettlements.map(settlement => 
          settlement.id === id ? { ...settlement, paid: true } : settlement
        ));
      }

      function deleteSettlement(id) {
        setPersonSettlements(personSettlements.filter(settlement => settlement.id !== id));
      }

      function applyAutoBudgetSuggestion(category) {
        if (autoBudgetSuggestions[category]) {
          updateBudget(category, autoBudgetSuggestions[category]);
        }
      }

      function addPerson(name) {
        if (name && !personList.includes(name)) {
          setPersonList([...personList, name]);
        }
      }

      function removePerson(name) {
        setPersonList(personList.filter(p => p !== name));
      }

      const getTransactionMonths = () => {
        const months = transactions.reduce((acc, tx) => {
          const date = new Date(tx.date);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          if (!acc.includes(monthYear)) {
            acc.push(monthYear);
          }
          return acc;
        }, []);
        return months.sort().reverse();
      };

      const filteredTransactions = transactionMonthFilter === "all" 
        ? transactions 
        : transactions.filter(tx => {
            const date = new Date(tx.date);
            const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            return monthYear === transactionMonthFilter;
          });

      const renderActiveView = () => {
        const commonMonths = getTransactionMonths();
        
        return (
          <div>
            <MonthFilter 
              selectedMonth={selectedMonth}
              setSelectedMonth={setSelectedMonth}
              availableMonths={commonMonths}
              budgets={budgets}
              setBudgets={setBudgets}
            />
          
            
            <div className="mt-4">
              {(() => {
                switch (activeView) {
                  case "transactionLog":
                    return <TransactionTable 
                      transactions={filteredTransactions} 
                      onDelete={deleteTransaction} 
                      onEdit={editTransaction}
                      monthFilter={transactionMonthFilter}
                      setMonthFilter={setTransactionMonthFilter}
                      availableMonths={commonMonths}
                      currentUser={currentUser}
                    />;
                  case "timeSpentAnalysis":
                    return <TimeSpentAnalysis 
                      transactions={filterByMonth(transactions, 'date')}
                      selectedMonth={selectedMonth}
                    />;
                  case "personSettlements":
                    return <PersonSettlements 
                      settlements={filterByMonth(personSettlements, 'date')} 
                      onMarkAsPaid={markAsPaid} 
                      onDelete={deleteSettlement}
                    />;
                  case "budgetPlanner":
                    return <BudgetPlanner 
                      budgets={getCurrentBudgets()}
                      onUpdate={updateBudget}
                      transactions={filterByMonth(transactions, 'date')}
                      autoSuggestions={autoBudgetSuggestions}
                      onApplySuggestion={applyAutoBudgetSuggestion}
                      selectedMonth={selectedMonth}
                    />;
                  case "monthlySuggestions":
                    return <AutoBudgetSuggestions 
                      suggestions={autoBudgetSuggestions}
                      budgets={getCurrentBudgets()}
                      onApplySuggestion={applyAutoBudgetSuggestion}
                      monthlyTrends={monthlyTrends}
                      selectedMonth={selectedMonth}
                    />;
                  case "expenseBreakdown":
                    return <PieChartComponent 
                      transactions={filterByMonth(transactions, 'date')} 
                      selectedMonth={selectedMonth}
                    />;
                  case "budgetCompletion":
                    return <BudgetCompletionVisualization 
                      transactions={filterByMonth(transactions, 'date')} 
                      budgets={getCurrentBudgets()}
                      selectedMonth={selectedMonth}
                    />;
                  case "costDrivers":
                    return <HEORCostDriversDashboard 
                      transactions={filterByMonth(transactions, 'date')} 
                      budgets={getCurrentBudgets()}
                      selectedMonth={selectedMonth}
                    />;
                  case "insights":
                    return <InsightsPanel 
                      transactions={transactions}
                      budgets={budgets}
                      customIncome={customIncome}
                    />;
                  case "goals":
                    return <GoalsSystem />;
                  default:
                    return (
                      <div className="space-y-4">
                        <div className="quote-container p-6 rounded-xl shadow-lg">
                          <div className="relative z-10">
                            <div className="flex items-center mb-4">
                              <div className="mr-3 p-2 bg-purple-100 dark:bg-purple-900/30 rounded-full">
                                <span className="text-2xl text-purple-600 dark:text-purple-300">üí≠</span>
                              </div>
                              <h3 className="text-xl font-bold text-purple-800 dark:text-purple-200">Money Wisdom</h3>
                            </div>
                            
                            <div className="fade-in mb-6">
                              <p className="quote-text text-gray-800 dark:text-gray-100 mb-4">
                                "{moneyQuotes[currentQuoteIndex].text}"
                              </p>
                              <div className="flex justify-between items-center">
                                <p className="quote-author text-purple-700 dark:text-purple-300">
                                  ‚Äî {moneyQuotes[currentQuoteIndex].author}
                                </p>
                                <div className="flex space-x-2">
                                  {moneyQuotes.map((_, index) => (
                                    <div 
                                      key={index}
                                      className={`quote-indicator ${index === currentQuoteIndex ? 'active' : ''}`}
                                      onClick={() => setCurrentQuoteIndex(index)}
                                    ></div>
                                  ))}
                                </div>
                              </div>
                            </div>
                          </div>
                          <div className="quote-icon">üí∏</div>
                            <div className="quote-icon"><i className="fas fa-coins text-gray-700 dark:text-gray-400"></i></div>
                        </div>
                        
                        <div>
                          <EnhancedTransactionForm 
                            onSubmit={addTransaction} 
                            personList={personList} 
                            addPerson={addPerson} 
                            removePerson={removePerson} 
                            currentUser={currentUser} 
                          />
                        </div>
                        
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-6 rounded-xl shadow-lg">
                          <h3 className="font-bold text-xl text-blue-800 dark:text-blue-200 mb-4">üí∞ Income & Balance Summary</h3>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Set Your Income
                              </label>
                              <div className="flex items-center">
                                <span className="mr-2 text-gray-600 dark:text-gray-400">‚Çπ</span>
                                <input
                                  type="number"
                                  value={customIncome}
                                  onChange={e => setCustomIncome(parseFloat(e.target.value) || 0)}
                                  className="income-input w-full p-2 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none"
                                  placeholder="Enter your income"
                                  step="0.01"
                                  min="0"
                                />
                              </div>
                              <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                Your customizable monthly income
                              </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-4 rounded-lg shadow">
                              <div className="text-sm font-medium text-gray-600 dark:text-gray-400">Total Income</div>
                              <div className="text-2xl font-bold text-green-700 dark:text-green-300 mt-1">‚Çπ{totalIncome.toFixed(2)}</div>
                              <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                Custom: ‚Çπ{customIncome.toFixed(2)} + Transactions: ‚Çπ{calculatedIncome.toFixed(2)}
                              </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 p-4 rounded-lg shadow">
                              <div className="text-sm font-medium text-gray-600 dark:text-gray-400">Total Expenses</div>
                              <div className="text-2xl font-bold text-red-700 dark:text-red-300 mt-1">‚Çπ{totalExpenses.toFixed(2)}</div>
                              <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                {transactions.filter(tx => tx.category.toLowerCase() !== "income").length} transactions
                              </div>
                            </div>
                            
                            <div className={`p-4 rounded-lg shadow ${remainingIncome >= 0 ? 'bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20' : 'bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20'}`}>
                              <div className="text-sm font-medium text-gray-600 dark:text-gray-400">Remaining Balance</div>
                              <div className={`text-2xl font-bold mt-1 ${remainingIncome >= 0 ? 'text-blue-700 dark:text-blue-300' : 'text-amber-700 dark:text-amber-300'}`}>
                                ‚Çπ{remainingIncome.toFixed(2)}
                              </div>
                              <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                {remainingIncome >= 0 ? '‚úì Positive balance' : '‚ö†Ô∏è Overspending'}
                              </div>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div className="bg-gradient-to-r from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 p-4 rounded-lg shadow">
                              <div className="flex items-center justify-between">
                                <div>
                                  <div className="text-sm font-medium text-gray-600 dark:text-gray-400">Money Owed to You</div>
                                  <div className="text-xl font-bold text-purple-700 dark:text-purple-300 mt-1">
                                    ‚Çπ{moneyOwedToYou.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    From {personSettlements.filter(s => !s.paid).length} pending settlements
                                  </div>
                                </div>
                                {moneyOwedToYou > 0 && (
                                  <div className="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-full">
                                    <span className="text-lg">üí∏</span>
                                  </div>
                                )}
                              </div>
                              {moneyOwedToYou > 0 && (
                                <div className="text-xs text-purple-600 dark:text-purple-400 mt-2">
                                  This amount will be added to your balance when collected
                                </div>
                              )}
                            </div>
                            
                            <div className="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 p-4 rounded-lg shadow">
                              <div className="flex items-center justify-between">
                                <div>
                                  <div className="text-sm font-medium text-gray-600 dark:text-gray-400">Available Now</div>
                                  <div className="text-xl font-bold text-emerald-700 dark:text-emerald-300 mt-1">
                                    ‚Çπ{(totalIncome - totalExpenses).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    Income minus expenses (excluding settlements)
                                  </div>
                                </div>
                                <div className="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-full">
                                  <span className="text-lg">üí∞</span>
                                </div>
                              </div>
                              <div className="text-xs text-emerald-600 dark:text-emerald-400 mt-2">
                                Amount you can spend right now
                              </div>
                            </div>
                          </div>
                        </div>
                    
                        <div>
                          <HEORCostDriversDashboard 
                            transactions={filterByMonth(transactions, 'date')} 
                            budgets={getCurrentBudgets()}
                            selectedMonth={selectedMonth}
                          />
                        </div>
                      </div>
                    );
                }
              })()}
            </div>
          </div>
        );
      };

      return (
        <div>
          <Navbar 
            currentUser={currentUser} 
            logoutUser={logoutUser}
            showDropdown={showDropdown}
            setShowDropdown={setShowDropdown}
            setActiveView={setActiveView}
            exportToCSV={exportToCSV}
            selectedMonth={selectedMonth}
            darkMode={darkMode}
            setDarkMode={setDarkMode}
          />
          <main className="p-4">
            {renderActiveView()}
          </main>
        </div>
      );
    }

    function MonthFilter({ selectedMonth, setSelectedMonth, availableMonths, budgets, setBudgets }) {
      const [showCustomMonth, setShowCustomMonth] = useState(false);
      const [customMonth, setCustomMonth] = useState(selectedMonth);

      const getAvailableMonths = () => {
        const months = new Set(availableMonths || []);
        const currentMonth = new Date().toISOString().slice(0, 7);
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        const lastMonthStr = `${lastMonth.getFullYear()}-${(lastMonth.getMonth() + 1).toString().padStart(2, '0')}`;
        
        months.add(currentMonth);
        months.add(lastMonthStr);
        
        return Array.from(months).sort().reverse();
      };

      const handleMonthChange = (month) => {
        if (selectedMonth !== month && selectedMonth !== "all" && budgets[selectedMonth] && Object.keys(budgets[selectedMonth] || {}).length > 0) {
          if (window.confirm(`Switch to ${month}? Your budgets for ${selectedMonth} will be saved automatically.`)) {
            setSelectedMonth(month);
            setShowCustomMonth(false);
          }
        } else {
          setSelectedMonth(month);
          setShowCustomMonth(false);
        }
      };

      const handleCustomMonthSubmit = () => {
        if (customMonth) {
          handleMonthChange(customMonth);
        }
      };

      const resetMonthBudgets = () => {
        if (window.confirm(`Reset budgets for ${selectedMonth}? This will clear all budget settings for this month.`)) {
          const updatedBudgets = { ...budgets };
          delete updatedBudgets[selectedMonth];
          setBudgets(updatedBudgets);
        }
      };

      return (
          <div className="flex flex-col md:flex-row items-start md:items-center gap-2 mb-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
            <div className="flex items-center gap-2">
              <i className="fas fa-calendar-alt text-blue-500"></i>
              <span className="font-medium">Month Filter:</span>
            </div>

            <div className="flex flex-wrap gap-2">
              <button
                onClick={() => setShowCustomMonth(!showCustomMonth)}
                className="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600"
              >
                {showCustomMonth ? 'Cancel' : 'Custom Month'}
              </button>
            </div>
          
          {showCustomMonth && (
            <div className="flex items-center gap-2 mt-2 md:mt-0">
              <input
                type="month"
                value={customMonth}
                onChange={(e) => setCustomMonth(e.target.value)}
                className="p-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700"
              />
              <button
                onClick={handleCustomMonthSubmit}
                className="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600"
              >
                Apply
              </button>
            </div>
          )}
          
          {selectedMonth !== "all" && (
            <div className="ml-auto">
              <button
                onClick={resetMonthBudgets}
                className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
              >
                Reset Month Budgets
              </button>
            </div>
          )}
        </div>
      );
    }

    function MonthlySummary({ selectedMonth, transactions, budgets, filterByMonth }) {
      const monthTransactions = filterByMonth(transactions, 'date');
      
      const totalSpent = monthTransactions
        .filter(tx => tx.category.toLowerCase() !== "income")
        .reduce((sum, tx) => sum + tx.amount, 0);
        
      const totalIncome = monthTransactions
        .filter(tx => tx.category.toLowerCase() === "income")
        .reduce((sum, tx) => sum + tx.amount, 0);
        
      const totalBudget = Object.values(budgets).reduce((a, b) => a + b, 0);
      const remainingBudget = totalBudget - totalSpent;
      
      return (
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-4 rounded-lg mb-4">
          <h3 className="font-bold text-lg mb-2">
            Monthly Summary for {new Date(selectedMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="p-3 bg-white dark:bg-gray-800 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Total Income</div>
              <div className="text-xl font-bold text-green-600">‚Çπ{totalIncome.toFixed(2)}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400">{monthTransactions.filter(tx => tx.category.toLowerCase() === "income").length} transactions</div>
            </div>
            <div className="p-3 bg-white dark:bg-gray-800 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Total Expenses</div>
              <div className="text-xl font-bold text-red-600">‚Çπ{totalSpent.toFixed(2)}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400">{monthTransactions.filter(tx => tx.category.toLowerCase() !== "income").length} transactions</div>
            </div>
            <div className="p-3 bg-white dark:bg-gray-800 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Budget Allocated</div>
              <div className="text-xl font-bold text-blue-600">‚Çπ{totalBudget.toFixed(2)}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400">{Object.keys(budgets).length} categories</div>
            </div>
            <div className="p-3 bg-white dark:bg-gray-800 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Remaining Budget</div>
              <div className={`text-xl font-bold ${remainingBudget >= 0 ? 'text-green-600' : 'text-red-600'}`}>‚Çπ{remainingBudget.toFixed(2)}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400">
                {totalBudget > 0 ? `${((totalSpent/totalBudget)*100).toFixed(1)}% utilized` : 'No budget set'}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function Navbar({ currentUser, logoutUser, showDropdown, setShowDropdown, setActiveView, exportToCSV, selectedMonth, darkMode, setDarkMode }) {
      return (
        <nav className="sticky top-0 z-50 bg-white dark:bg-gray-800 p-4 shadow-md flex justify-between items-center">
          <div className="flex items-center gap-4">
            <div className="font-bold text-lg">MoneyWise</div>
          </div>
          <div className="flex gap-3 items-center relative">
            <button 
              onClick={() => setActiveView("home")}
              className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm"
            >
              Home
            </button>
            <span className="text-xs sm:text-sm px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded">üë§ {currentUser}</span>
            <div className="relative">
              <button 
                onClick={() => setShowDropdown(!showDropdown)}
                className="p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition"
              >
                <i className="fas fa-bars"></i>
              </button>
              <div className={`dropdown-menu ${showDropdown ? 'show' : ''}`}>
                <button className="dropdown-item" onClick={() => { setActiveView("transactionLog"); setShowDropdown(false); }}>
                  <i className="fas fa-receipt mr-2"></i> Transaction Log
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("timeSpentAnalysis"); setShowDropdown(false); }}>
                  <i className="fas fa-clock mr-2"></i> Time Spent Analysis
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("personSettlements"); setShowDropdown(false); }}>
                  <i className="fas fa-users mr-2"></i> Person-wise Settlements
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("budgetPlanner"); setShowDropdown(false); }}>
                  <i className="fas fa-chart-pie mr-2"></i> Budget Planner
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("monthlySuggestions"); setShowDropdown(false); }}>
                  <i className="fas fa-lightbulb mr-2"></i> Monthly Budget Suggestions
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("expenseBreakdown"); setShowDropdown(false); }}>
                  <i className="fas fa-chart-pie mr-2"></i> Expense Breakdown
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("budgetCompletion"); setShowDropdown(false); }}>
                  <i className="fas fa-tasks mr-2"></i> Budget Completion
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("costDrivers"); setShowDropdown(false); }}>
                  <i className="fas fa-chart-line mr-2"></i> Cost Drivers Analysis
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("insights"); setShowDropdown(false); }}>
                  <i className="fas fa-lightbulb mr-2"></i> Insights 
                </button>
                <button className="dropdown-item" onClick={() => { setActiveView("goals"); setShowDropdown(false); }}>
                  <i className="fas fa-bullseye mr-2"></i> Goals 
                </button>
                <button className="dropdown-item" onClick={exportToCSV}>
                  <i className="fas fa-file-export mr-2"></i> Export CSV
                </button>
                <button className="dropdown-item" onClick={() => { 
                  window.open('https://www.linkedin.com/in/subhra-prasad-chakraborty-3b91aa285?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app', '_blank');
                  setShowDropdown(false);
                }}>
                  <i className="fas fa-envelope mr-2"></i> Contact Us
                </button>
                <button className="dropdown-item" onClick={() => { logoutUser(); setShowDropdown(false); }}>
                  <i className="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
              </div>
            </div>
          </div>
        </nav>
      );
    }

    function TimeSpentAnalysis({ transactions, selectedMonth }) {
      const [analysisType, setAnalysisType] = useState("daily");
      const chartRef = React.useRef(null);
      const chartInstance = React.useRef(null);
      
      const calculateTimeSpent = () => {
        const data = { daily: {}, weekly: {}, monthly: {} };
        const categoryTime = {};
        
        transactions.forEach(tx => {
          const date = new Date(tx.date);
          const dayKey = date.toISOString().split('T')[0];
          const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
          const weekNum = Math.ceil((date.getDate() + new Date(date.getFullYear(), date.getMonth(), 1).getDay()) / 7);
          const weekKey = `W${weekNum}`;
          const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          
          data.daily[dayKey] = (data.daily[dayKey] || 0) + 1;
          data.weekly[weekKey] = (data.weekly[weekKey] || 0) + 1;
          data.monthly[monthKey] = (data.monthly[monthKey] || 0) + 1;
          
          categoryTime[tx.category] = (categoryTime[tx.category] || 0) + 1;
        });
        
        return { periodData: data, categoryData: categoryTime };
      };
      
      const { periodData, categoryData } = calculateTimeSpent();
      
      useEffect(() => {
        if (chartRef.current && Object.keys(periodData[analysisType]).length > 0) {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
          
          const selectedData = periodData[analysisType];
          const sortedKeys = Object.keys(selectedData).sort();
          const dataValues = sortedKeys.map(k => selectedData[k]);
          
          let labels = sortedKeys;
          let title = `${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)} Transaction Frequency`;
          
          if (analysisType === "daily") {
            labels = sortedKeys.map(date => {
              const d = new Date(date);
              return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
          }
          
          const ctx = chartRef.current.getContext('2d');
          chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Transaction Count',
                data: dataValues,
                backgroundColor: dataValues.map((_, idx) => {
                  const colors = ['#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
                  return colors[idx % colors.length];
                }),
                borderColor: dataValues.map((_, idx) => {
                  const colors = ['#1e40af', '#0369a1', '#047857', '#d97706', '#b91c1c', '#6d28d9', '#be185d'];
                  return colors[idx % colors.length];
                }),
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
                hoverBackgroundColor: '#6366f1',
                hoverBorderColor: '#4f46e5',
                hoverBorderWidth: 3,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              indexAxis: 'x',
              plugins: {
                legend: { 
                  display: true,
                  labels: {
                    font: { size: 12, weight: 'bold' },
                    color: '#666',
                    padding: 15
                  }
                },
                title: {
                  display: true,
                  text: title,
                  font: { size: 14, weight: 'bold' },
                  padding: 20
                },
                tooltip: {
                  backgroundColor: 'rgba(0,0,0,0.8)',
                  padding: 12,
                  titleFont: { size: 13, weight: 'bold' },
                  bodyFont: { size: 12 },
                  cornerRadius: 8,
                  displayColors: true,
                  callbacks: {
                    label: function(context) {
                      return `Transactions: ${context.raw}`;
                    },
                    afterLabel: function(context) {
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percent = ((context.raw / total) * 100).toFixed(1);
                      return `(${percent}% of total)`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                    font: { size: 11 }
                  },
                  grid: {
                    color: 'rgba(0,0,0,0.05)',
                    drawBorder: true
                  },
                  title: {
                    display: true,
                    text: 'Transaction Count',
                    font: { weight: 'bold' }
                  }
                },
                x: {
                  ticks: {
                    font: { size: 11 }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }
        
        return () => {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
        };
      }, [analysisType, transactions, selectedMonth]);
      
      const selectedData = periodData[analysisType];
      const sortedPeriods = Object.keys(selectedData).sort();
      
      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="font-semibold text-lg">‚è±Ô∏è Time Spent Analysis</h2>
            <div className="text-sm text-gray-600 dark:text-gray-400">
              {selectedMonth === "all" ? "All Time" : `Month: ${selectedMonth}`}
            </div>
          </div>
          
          <div className="flex gap-2 flex-wrap">
            {['daily', 'weekly', 'monthly'].map(type => (
              <button
                key={type}
                onClick={() => setAnalysisType(type)}
                className={`px-4 py-2 rounded-lg font-medium transition-all duration-300 transform hover:scale-105 ${
                  analysisType === type
                    ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg'
                    : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600'
                }`}
              >
                {type.charAt(0).toUpperCase() + type.slice(1)}
              </button>
            ))}
          </div>
          
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-4 rounded-lg">
            {sortedPeriods.length > 0 ? (
              <canvas ref={chartRef} style={{ maxHeight: '350px' }}></canvas>
            ) : (
              <p className="text-gray-500 dark:text-gray-400 text-center py-8">No data available for selected period</p>
            )}
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border-l-4 border-purple-500">
              <h3 className="font-semibold mb-3 text-purple-900 dark:text-purple-200">Top Categories</h3>
              <div className="space-y-2">
                {Object.entries(categoryData)
                  .sort((a, b) => b[1] - a[1])
                  .slice(0, 5)
                  .map(([category, count]) => (
                    <div key={category} className="flex justify-between items-center p-2 bg-white dark:bg-gray-800 rounded hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-colors duration-200">
                      <span className="text-sm font-medium truncate">{category}</span>
                      <span className="text-sm font-bold text-purple-600 dark:text-purple-400 ml-2">{count}</span>
                    </div>
                  ))}
              </div>
            </div>
            
            <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-l-4 border-blue-500">
              <h3 className="font-semibold mb-3 text-blue-900 dark:text-blue-200">Summary</h3>
              <div className="space-y-3">
                <div className="flex justify-between p-2 bg-white dark:bg-gray-800 rounded hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors duration-200">
                  <span className="text-sm">Total Transactions</span>
                  <span className="font-bold text-blue-600 dark:text-blue-400">{transactions.length}</span>
                </div>
                <div className="flex justify-between p-2 bg-white dark:bg-gray-800 rounded hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors duration-200">
                  <span className="text-sm">Periods with Data</span>
                  <span className="font-bold text-blue-600 dark:text-blue-400">{sortedPeriods.length}</span>
                </div>
                <div className="flex justify-between p-2 bg-white dark:bg-gray-800 rounded hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors duration-200">
                  <span className="text-sm">Avg per Period</span>
                  <span className="font-bold text-blue-600 dark:text-blue-400">
                    {sortedPeriods.length > 0 ? (transactions.length / sortedPeriods.length).toFixed(1) : 0}
                  </span>
                </div>
                <div className="flex justify-between p-2 bg-white dark:bg-gray-800 rounded hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors duration-200">
                  <span className="text-sm">Busiest Period</span>
                  <span className="font-bold text-blue-600 dark:text-blue-400">
                    {sortedPeriods.length > 0 ? Math.max(...sortedPeriods.map(p => selectedData[p])) : 0}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function EnhancedTransactionForm({ onSubmit, personList, addPerson, removePerson, currentUser }) {
      const [form, setForm] = useState({ 
        date: new Date().toISOString().split('T')[0], 
        description: "", 
        category: "", 
        amount: "", 
        groupPay: "No", 
        necessity: "Needs",
        groupDetails: {
          splitType: "equal",
          includeMe: true,
          totalPeople: 2,
          people: [
            { id: Date.now() + 1, name: currentUser, amount: 0, includeMe: true, isCustomName: false },
            { id: Date.now() + 2, name: "Friend 1", amount: 0, includeMe: false, isCustomName: false }
          ]
        }
      });
      
      const [newPersonName, setNewPersonName] = useState("");
      
      const handleChange = e => setForm({ ...form, [e.target.name]: e.target.value });
      
      const handleGroupDetailsChange = (field, value) => {
        setForm({
          ...form,
          groupDetails: {
            ...form.groupDetails,
            [field]: value
          }
        });
      };
      
      const handlePersonChange = (index, field, value) => {
        const newPeople = [...form.groupDetails.people];
        newPeople[index] = {
          ...newPeople[index],
          [field]: value
        };
        
        handleGroupDetailsChange('people', newPeople);
      };
      
      const handleSplitTypeChange = (type) => {
        const totalAmount = parseFloat(form.amount) || 0;
        const peopleCount = form.groupDetails.people.length;
        const newPeople = [...form.groupDetails.people];
        
        if (type === 'equal') {
          const equalAmount = totalAmount / peopleCount;
          newPeople.forEach((person, index) => {
            newPeople[index] = {
              ...person,
              amount: equalAmount
            };
          });
        }
        
        setForm({
          ...form,
          groupDetails: {
            ...form.groupDetails,
            splitType: type,
            people: newPeople
          }
        });
      };
      
      const handleAddPerson = () => {
        if (newPersonName.trim()) {
          const totalAmount = parseFloat(form.amount) || 0;
          const peopleCount = form.groupDetails.people.length + 1;
          const newPerson = {
            id: Date.now(),
            name: newPersonName.trim(),
            amount: form.groupDetails.splitType === 'equal' ? totalAmount / peopleCount : 0,
            includeMe: false,
            isCustomName: true
          };
          
          const newPeople = [...form.groupDetails.people, newPerson];
          
          if (!personList.includes(newPersonName.trim())) {
            addPerson(newPersonName.trim());
          }
          
          if (form.groupDetails.splitType === 'equal') {
            const equalAmount = totalAmount / newPeople.length;
            newPeople.forEach((person, index) => {
              newPeople[index] = {
                ...person,
                amount: equalAmount
              };
            });
          }
          
          setForm({
            ...form,
            groupDetails: {
              ...form.groupDetails,
              people: newPeople,
              totalPeople: newPeople.length
            }
          });
          setNewPersonName("");
        }
      };
      
      const handleRemovePerson = (id) => {
        const newPeople = form.groupDetails.people.filter(person => person.id !== id);
        const totalAmount = parseFloat(form.amount) || 0;
        
        if (form.groupDetails.splitType === 'equal') {
          const equalAmount = totalAmount / newPeople.length;
          newPeople.forEach((person, index) => {
            newPeople[index] = {
              ...person,
              amount: equalAmount
            };
          });
        }
        
        setForm({
          ...form,
          groupDetails: {
            ...form.groupDetails,
            people: newPeople,
            totalPeople: newPeople.length
          }
        });
      };
      
      const handleIncludeMeToggle = () => {
        const includeMe = !form.groupDetails.includeMe;
        const totalAmount = parseFloat(form.amount) || 0;
        
        let newPeople = [...form.groupDetails.people];
        
        if (includeMe) {
          if (!newPeople.some(p => p.includeMe)) {
            newPeople.unshift({
              id: Date.now(),
              name: currentUser,
              amount: form.groupDetails.splitType === 'equal' ? totalAmount / (newPeople.length + 1) : 0,
              includeMe: true,
              isCustomName: false
            });
          }
        } else {
          newPeople = newPeople.filter(person => !person.includeMe);
        }
        
        if (form.groupDetails.splitType === 'equal' && newPeople.length > 0) {
          const equalAmount = totalAmount / newPeople.length;
          newPeople.forEach((person, index) => {
            newPeople[index] = {
              ...person,
              amount: equalAmount
            };
          });
        }
        
        setForm({
          ...form,
          groupDetails: {
            ...form.groupDetails,
            includeMe,
            people: newPeople,
            totalPeople: newPeople.length
          }
        });
      };
      
      const handleTotalPeopleChange = (count) => {
        const currentCount = form.groupDetails.people.length;
        const totalAmount = parseFloat(form.amount) || 0;
        
        let newPeople = [...form.groupDetails.people];
        
        if (count > currentCount) {
          for (let i = currentCount; i < count; i++) {
            const existingNames = newPeople.map(p => p.name);
            let newName = `Person ${i + 1}`;
            let nameIndex = 1;
            
            while (existingNames.includes(newName)) {
              newName = `Person ${i + 1 + nameIndex}`;
              nameIndex++;
            }
            
            newPeople.push({
              id: Date.now() + i,
              name: newName,
              amount: form.groupDetails.splitType === 'equal' ? totalAmount / (i + 1) : 0,
              includeMe: false,
              isCustomName: false
            });
          }
        } else if (count < currentCount) {
          const peopleToRemove = currentCount - count;
          let removedCount = 0;
          
          for (let i = newPeople.length - 1; i >= 0 && removedCount < peopleToRemove; i--) {
            if (!newPeople[i].includeMe) {
              newPeople.splice(i, 1);
              removedCount++;
            }
          }
        }
        
        if (form.groupDetails.splitType === 'equal' && newPeople.length > 0) {
          const equalAmount = totalAmount / newPeople.length;
          newPeople.forEach((person, index) => {
            newPeople[index] = {
              ...person,
              amount: equalAmount
            };
          });
        }
        
        setForm({
          ...form,
          groupDetails: {
            ...form.groupDetails,
            people: newPeople,
            totalPeople: newPeople.length
          }
        });
      };
      
      const calculateTotal = () => {
        return form.groupDetails.people.reduce((sum, person) => sum + (parseFloat(person.amount) || 0), 0);
      };
      
      const handleSubmit = e => {
        e.preventDefault();
        if (!form.date || !form.description || !form.category || form.amount <= 0) {
          return alert("All basic fields are required");
        }
        
        if (form.groupPay === "Yes") {
          if (form.groupDetails.people.length === 0) {
            return alert("Please add at least one person for group payment");
          }
          
          const totalCalculated = calculateTotal();
          const enteredAmount = parseFloat(form.amount);
          
          if (Math.abs(totalCalculated - enteredAmount) > 0.01) {
            return alert(`Amount mismatch! Entered: ‚Çπ${enteredAmount.toFixed(2)}, Calculated: ‚Çπ${totalCalculated.toFixed(2)}. Please adjust the amounts.`);
          }
          
          const finalPeople = form.groupDetails.people.map(person => ({
            ...person,
            amount: parseFloat(person.amount) || 0
          }));
          
          const transactionData = { 
            ...form, 
            amount: enteredAmount,
            groupDetails: {
              ...form.groupDetails,
              people: finalPeople,
              totalPeople: finalPeople.length
            }
          };
          
          onSubmit(transactionData);
        } else {
          const transactionData = { 
            ...form, 
            amount: parseFloat(form.amount),
            groupDetails: null
          };
          
          onSubmit(transactionData);
        }
        
        setForm({ 
          date: new Date().toISOString().split('T')[0], 
          description: "", 
          category: "", 
          amount: "", 
          groupPay: "No", 
          necessity: "Needs",
          groupDetails: {
            splitType: "equal",
            includeMe: true,
            totalPeople: 2,
            people: [
              { id: Date.now() + 1, name: currentUser, amount: 0, includeMe: true, isCustomName: false },
              { id: Date.now() + 2, name: "Friend 1", amount: 0, includeMe: false, isCustomName: false }
            ]
          }
        });
      };
      
      useEffect(() => {
        if (form.groupPay === "Yes" && form.groupDetails.splitType === "equal") {
          const totalAmount = parseFloat(form.amount) || 0;
          const peopleCount = form.groupDetails.people.length;
          
          if (peopleCount > 0) {
            const equalAmount = totalAmount / peopleCount;
            const newPeople = form.groupDetails.people.map(person => ({
              ...person,
              amount: equalAmount
            }));
            
            setForm({
              ...form,
              groupDetails: {
                ...form.groupDetails,
                people: newPeople
              }
            });
          }
        }
      }, [form.amount, form.groupPay]);
      
      return (
        <form onSubmit={handleSubmit} className="bg-white dark:bg-gray-800 p-4 rounded shadow space-y-3">
          <h2 className="font-semibold text-lg mb-2">Add Transaction</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label className="block text-sm mb-1">Date</label>
              <input type="date" name="date" value={form.date} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700" required />
            </div>
            
            <div>
              <label className="block text-sm mb-1">Description</label>
              <input type="text" name="description" placeholder="Description" value={form.description} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700" required />
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label className="block text-sm mb-1">Category</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700" required>
                <option value="">Select Category</option>
                {["Rent & Utilities","Foods & cravings","Daily Living","Travel & Transport","Fitness & Health","Family Support","Entertainment & Subscriptions","Personal Care & Shopping","Investments","Personal EMIs","Emergency Funds"].map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
            </div>
            
            <div>
              <label className="block text-sm mb-1">Total Amount (‚Çπ)</label>
              <input type="number" step="0.01" name="amount" placeholder="Total Amount" value={form.amount} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700" required />
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label className="block text-sm mb-1">Group Payment</label>
              <select name="groupPay" value={form.groupPay} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700">
                <option value="No">No - Personal</option>
                <option value="Yes">Yes - Shared</option>
              </select>
            </div>
            
            <div>
              <label className="block text-sm mb-1">Necessity Type</label>
              <select name="necessity" value={form.necessity} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700">
                <option value="Needs">Needs</option>
                <option value="Wants">Wants</option>
                <option value="Investment">Investment</option>
              </select>
            </div>
          </div>
          
          {form.groupPay === "Yes" && (
            <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded space-y-4">
              <h3 className="font-medium text-lg">üë• Group Payment Details</h3>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm mb-2">Split Type</label>
                  <div className="flex gap-2">
                    <button
                      type="button"
                      onClick={() => handleSplitTypeChange('equal')}
                      className={`px-3 py-2 rounded flex-1 ${form.groupDetails.splitType === 'equal' ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700'}`}
                    >
                      Equal Split
                    </button>
                    <button
                      type="button"
                      onClick={() => handleSplitTypeChange('custom')}
                      className={`px-3 py-2 rounded flex-1 ${form.groupDetails.splitType === 'custom' ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700'}`}
                    >
                      Custom Split
                    </button>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm mb-2">Total Number of People</label>
                  <div className="flex items-center gap-2">
                    <button
                      type="button"
                      onClick={() => handleTotalPeopleChange(Math.max(1, form.groupDetails.totalPeople - 1))}
                      className="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded"
                    >
                      -
                    </button>
                    <input
                      type="number"
                      min="1"
                      value={form.groupDetails.totalPeople}
                      onChange={(e) => handleTotalPeopleChange(parseInt(e.target.value) || 1)}
                      className="w-16 p-2 text-center rounded bg-gray-100 dark:bg-gray-700"
                    />
                    <button
                      type="button"
                      onClick={() => handleTotalPeopleChange(form.groupDetails.totalPeople + 1)}
                      className="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded"
                    >
                      +
                    </button>
                    <span className="text-sm ml-2">{form.groupDetails.people.length} configured</span>
                  </div>
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                <input
                  type="checkbox"
                  id="includeMe"
                  checked={form.groupDetails.includeMe}
                  onChange={handleIncludeMeToggle}
                  className="rounded"
                />
                <label htmlFor="includeMe" className="text-sm">
                  Include myself ({currentUser}) in the split
                </label>
              </div>
              
              <div className="space-y-3">
                <label className="block text-sm font-medium">People & Amounts</label>
                
                {form.groupDetails.people.map((person, index) => (
                  <div key={person.id} className="flex flex-col md:flex-row gap-2 p-3 bg-white dark:bg-gray-800 rounded border">
                    <div className="flex-1">
                      <label className="block text-xs mb-1">Person {index + 1}</label>
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={person.name}
                          onChange={(e) => handlePersonChange(index, 'name', e.target.value)}
                          className="flex-1 p-2 rounded bg-gray-100 dark:bg-gray-700 text-sm"
                          placeholder="Name"
                          disabled={person.includeMe}
                        />
                        {!person.includeMe && (
                          <button
                            type="button"
                            onClick={() => handleRemovePerson(person.id)}
                            className="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                          >
                            Remove
                          </button>
                        )}
                      </div>
                      {person.includeMe && (
                        <div className="text-xs text-green-600 dark:text-green-400 mt-1">(You)</div>
                      )}
                    </div>
                    
                    <div className="w-32">
                      <label className="block text-xs mb-1">Amount (‚Çπ)</label>
                      <input
                        type="number"
                        step="0.01"
                        value={person.amount.toFixed(2)}
                        onChange={(e) => handlePersonChange(index, 'amount', parseFloat(e.target.value) || 0)}
                        className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-sm"
                        disabled={form.groupDetails.splitType === 'equal'}
                      />
                    </div>
                  </div>
                ))}
                
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={newPersonName}
                    onChange={(e) => setNewPersonName(e.target.value)}
                    placeholder="Add specific person name"
                    className="flex-1 p-2 rounded bg-gray-100 dark:bg-gray-700 text-sm"
                  />
                  <button
                    type="button"
                    onClick={handleAddPerson}
                    className="px-3 py-2 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                  >
                    Add Person
                  </button>
                </div>
              </div>
              
              <div className="p-3 bg-green-50 dark:bg-green-900/20 rounded">
                <div className="flex justify-between items-center">
                  <div>
                    <div className="font-medium">Summary</div>
                    <div className="text-sm">
                      Total: ‚Çπ{form.amount || 0}<br/>
                      People: {form.groupDetails.people.length}<br/>
                      Split: {form.groupDetails.splitType === 'equal' ? 'Equal' : 'Custom'}
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="font-bold text-lg">
                      ‚Çπ{calculateTotal().toFixed(2)}
                    </div>
                    <div className="text-sm">
                      {Math.abs(calculateTotal() - (parseFloat(form.amount) || 0)) > 0.01 ? (
                        <span className="text-red-600">Amounts don't match!</span>
                      ) : (
                        <span className="text-green-600">‚úì Amounts match</span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          <button type="submit" className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Add Transaction</button>
        </form>
      );
    }

    function BudgetPlanner({ budgets, onUpdate, transactions, autoSuggestions, onApplySuggestion, selectedMonth }) {
      const categories = [...new Set(transactions.map(t => t.category))].filter(cat => cat.toLowerCase() !== "income");

      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h2 className="font-semibold text-lg mb-3">Budget Planner - {selectedMonth === "all" ? "All Time" : new Date(selectedMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h2>
          <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Set monthly budgets for each category. Budgets are saved per month.
          </p>
          
          {categories.length === 0 ? (
            <p className="text-gray-500 dark:text-gray-400 p-2">No transactions in selected month to set budgets for.</p>
          ) : (
            categories.map(cat => {
              const spent = transactions.filter(t => t.category === cat).reduce((sum, t) => sum + t.amount, 0);
              const budget = budgets[cat] || 0;
              const remaining = budget - spent;
              const percentageUsed = budget > 0 ? Math.min(100, (spent/budget)*100) : 0;
              
              return (
                <div key={cat} className="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded">
                  <div className="flex justify-between items-center mb-2">
                    <label className="font-medium">{cat}</label>
                    {autoSuggestions[cat] && budget === 0 && (
                      <button 
                        onClick={() => onApplySuggestion(cat)}
                        className="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
                      >
                        Apply Suggestion: ‚Çπ{autoSuggestions[cat]}
                      </button>
                    )}
                  </div>
                  <div className="flex gap-2 mb-2">
                    <input 
                      type="number" 
                      className="p-2 rounded bg-gray-100 dark:bg-gray-800 w-full" 
                      value={budget} 
                      placeholder="Set budget"
                      onChange={e => onUpdate(cat, e.target.value)} 
                    />
                  </div>
                  <div className="w-full bg-gray-300 dark:bg-gray-600 rounded h-3 mb-1">
                    <div 
                      className="h-3 rounded" 
                      style={{ 
                        width: `${percentageUsed}%`,
                        backgroundColor: percentageUsed > 90 ? '#EF4444' : percentageUsed > 70 ? '#F59E0B' : '#10B981'
                      }}
                    ></div>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span>Spent: ‚Çπ{spent.toFixed(2)}</span>
                    <span className={remaining < 0 ? 'text-red-500' : 'text-green-500'}>
                      Remaining: ‚Çπ{remaining.toFixed(2)}
                    </span>
                    <span>{percentageUsed.toFixed(1)}%</span>
                  </div>
                </div>
              );
            })
          )}
        </div>
      );
    }

    function AutoBudgetSuggestions({ suggestions, budgets, onApplySuggestion, monthlyTrends, selectedMonth }) {
      const [selectedCategory, setSelectedCategory] = useState(Object.keys(suggestions)[0] || '');

      if (Object.keys(suggestions).length === 0) {
        return (
          <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
            <h2 className="font-semibold text-lg mb-2">Auto-Budget Suggestions</h2>
            <p className="text-gray-500 dark:text-gray-400">Add more transactions to get budget suggestions</p>
          </div>
        );
      }

      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h2 className="font-semibold text-lg mb-3">üìä Monthly Auto-Budget Suggestions</h2>
          <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
            Based on your spending patterns {selectedMonth === "all" ? "across all months" : `for ${selectedMonth}`}
          </p>
          
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div className="space-y-3">
              <h3 className="font-medium">Suggested Budgets</h3>
              {Object.entries(suggestions).map(([category, suggestedAmount]) => {
                const currentBudget = budgets[category] || 0;
                return (
                  <div key={category} className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-100 dark:border-blue-800">
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="font-medium">{category}</div>
                        <div className="text-sm text-gray-600 dark:text-gray-400">
                          Suggested: ‚Çπ{suggestedAmount}
                          {currentBudget > 0 && (
                            <span className="ml-2">
                              (Current: ‚Çπ{currentBudget})
                            </span>
                          )}
                        </div>
                      </div>
                      <button 
                        onClick={() => onApplySuggestion(category)}
                        className={`px-3 py-1 rounded text-sm ${currentBudget > 0 ? 'bg-gray-200 dark:bg-gray-700' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
                      >
                        {currentBudget > 0 ? 'Update' : 'Apply'}
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
            
            <div>
              <h3 className="font-medium mb-2">Monthly Trends</h3>
              <select 
                value={selectedCategory} 
                onChange={(e) => setSelectedCategory(e.target.value)}
                className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 mb-3"
              >
                {Object.keys(suggestions).map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
              
              {monthlyTrends[selectedCategory] && monthlyTrends[selectedCategory].length > 0 ? (
                <div className="space-y-2">
                  <h4 className="font-medium text-sm">Monthly Spending for {selectedCategory}</h4>
                  {monthlyTrends[selectedCategory].map((trend, index) => (
                    <div key={index} className="p-2 bg-gray-50 dark:bg-gray-700 rounded">
                      <div className="flex justify-between">
                        <span>{trend.month}</span>
                        <span className="font-medium">‚Çπ{trend.amount.toFixed(2)}</span>
                      </div>
                      <div className="w-full bg-gray-300 dark:bg-gray-600 rounded h-2 mt-1">
                        <div 
                          className="h-2 rounded bg-purple-500" 
                          style={{ 
                            width: `${Math.min(100, (trend.amount / Math.max(...monthlyTrends[selectedCategory].map(t => t.amount))) * 100)}%` 
                          }}
                        ></div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-500 dark:text-gray-400 text-sm">No monthly trend data available</p>
              )}
            </div>
          </div>
        </div>
      );
    }

    function PersonSettlements({ settlements, onMarkAsPaid, onDelete }) {
      const [filterPerson, setFilterPerson] = useState("all");
      
      const personNames = [...new Set(settlements.map(s => s.personName))];
      
      const filteredSettlements = filterPerson === "all" 
        ? settlements 
        : settlements.filter(s => s.personName === filterPerson);
      
      const pendingSettlements = filteredSettlements.filter(s => !s.paid);
      const completedSettlements = filteredSettlements.filter(s => s.paid);
      
      const personTotals = {};
      settlements.forEach(s => {
        if (!s.paid) {
          personTotals[s.personName] = (personTotals[s.personName] || 0) + s.perPersonAmount;
        }
      });

      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <div className="flex justify-between items-center mb-3">
            <h2 className="font-semibold text-lg">üë• Person-wise Settlements</h2>
            <select 
              value={filterPerson} 
              onChange={(e) => setFilterPerson(e.target.value)}
              className="p-2 rounded bg-gray-100 dark:bg-gray-700 text-sm"
            >
              <option value="all">All Persons</option>
              {personNames.map(name => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>
          </div>
          
          {pendingSettlements.length === 0 ? (
            <p className="text-gray-500 dark:text-gray-400 p-2">No pending settlements</p>
          ) : (
            <div className="space-y-3 mb-4">
              <h3 className="font-medium text-red-600 dark:text-red-400">Pending Payments</h3>
              {pendingSettlements.map(settlement => (
                <div key={settlement.id} className="p-3 bg-red-50 dark:bg-red-900/20 rounded border border-red-100 dark:border-red-800">
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="font-medium">{settlement.description}</div>
                      <div className="text-sm text-gray-600 dark:text-gray-400">
                        Date: {settlement.date} ‚Ä¢ With: {settlement.personName}
                      </div>
                      <div className="text-sm">
                        Total: ‚Çπ{settlement.totalAmount.toFixed(2)} ‚Ä¢ 
                        {settlement.numPeople} people ‚Ä¢ 
                        Each pays: ‚Çπ{settlement.perPersonAmount.toFixed(2)}
                      </div>
                      <div className="text-sm text-blue-600 dark:text-blue-400">
                        Category: {settlement.category}
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => onMarkAsPaid(settlement.id)}
                        className="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                      >
                        Mark Paid
                      </button>
                      <button 
                        onClick={() => onDelete(settlement.id)}
                        className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {completedSettlements.length > 0 && (
            <div className="space-y-3">
              <h3 className="font-medium text-green-600 dark:text-green-400">Completed Payments</h3>
              {completedSettlements.map(settlement => (
                <div key={settlement.id} className="p-3 bg-green-50 dark:bg-green-900/20 rounded border border-green-100 dark:border-green-800 opacity-75">
                  <div className="flex justify-between">
                    <div>
                      <div className="font-medium line-through">{settlement.description}</div>
                      <div className="text-sm text-gray-600 dark:text-gray-400">
                        Date: {settlement.date} ‚Ä¢ With: {settlement.personName}
                      </div>
                    </div>
                    <span className="text-green-600 dark:text-green-400">‚úì Paid</span>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          <div className="mt-3">
            <h4 className="font-medium mb-2">Person-wise Summary</h4>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
              {Object.entries(personTotals).map(([person, amount]) => (
                <div key={person} className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                  <div className="font-medium">{person}</div>
                  <div className="text-lg font-bold text-red-600">‚Çπ{amount.toFixed(2)}</div>
                  <div className="text-sm text-gray-600">pending</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function HEORCostDriversDashboard({ transactions, budgets, selectedMonth }) {
      const categorySpending = {};
      const categoryBudgets = {};
      const categoryNeedsWants = {};
      
      transactions.forEach(tx => {
        if (tx.category.toLowerCase() !== "income") {
          categorySpending[tx.category] = (categorySpending[tx.category] || 0) + tx.amount;
          
          if (!categoryNeedsWants[tx.category]) {
            categoryNeedsWants[tx.category] = { needs: 0, wants: 0, investment: 0 };
          }
          categoryNeedsWants[tx.category][tx.necessity.toLowerCase()] += tx.amount;
        }
      });

      Object.keys(budgets).forEach(cat => {
        categoryBudgets[cat] = budgets[cat];
      });

      const allCategories = [...new Set([...Object.keys(categorySpending), ...Object.keys(categoryBudgets)])];
      
      const totalSpending = Object.values(categorySpending).reduce((a, b) => a + b, 0);

      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h2 className="font-semibold text-lg mb-3">üìà Cost Drivers Dashboard</h2>
          <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Analysis of your spending drivers {selectedMonth === "all" ? "across all months" : `for ${selectedMonth}`}
          </p>
          
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b dark:border-gray-700">
                  <th className="text-left p-2">Category</th>
                  <th className="text-left p-2">Total Spent</th>
                  <th className="text-left p-2">Budget</th>
                  <th className="text-left p-2">% of Total</th>
                  <th className="text-left p-2">Variance</th>
                  <th className="text-left p-2">Needs/Wants Split</th>
                </tr>
              </thead>
              <tbody>
                {allCategories.map(cat => {
                  const spent = categorySpending[cat] || 0;
                  const budget = categoryBudgets[cat] || 0;
                  const variance = budget > 0 ? ((spent - budget) / budget * 100).toFixed(1) : 'N/A';
                  const percentOfTotal = totalSpending > 0 ? ((spent / totalSpending) * 100).toFixed(1) : 0;
                  const needsWantsData = categoryNeedsWants[cat] || { needs: 0, wants: 0, investment: 0 };
                  const totalCat = needsWantsData.needs + needsWantsData.wants + needsWantsData.investment;
                  
                  return (
                    <tr key={cat} className="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                      <td className="p-2 font-medium">{cat}</td>
                      <td className="p-2">‚Çπ{spent.toFixed(2)}</td>
                      <td className="p-2">‚Çπ{budget.toFixed(2)}</td>
                      <td className="p-2">
                        <div className="flex items-center">
                          <div className="w-16 bg-gray-200 dark:bg-gray-700 rounded h-2 mr-2">
                            <div 
                              className="h-2 rounded bg-blue-500" 
                              style={{ width: `${Math.min(100, percentOfTotal)}%` }}
                            ></div>
                          </div>
                          {percentOfTotal}%
                        </div>
                      </td>
                      <td className="p-2">
                        <span className={variance > 0 ? 'text-red-500' : 'text-green-500'}>
                          {variance === 'N/A' ? 'N/A' : `${variance}%`}
                        </span>
                      </td>
                      <td className="p-2">
                        <div className="flex space-x-1">
                          {needsWantsData.needs > 0 && (
                            <span className="text-xs px-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300 rounded">
                              N: {(needsWantsData.needs/totalCat*100).toFixed(0)}%
                            </span>
                          )}
                          {needsWantsData.wants > 0 && (
                            <span className="text-xs px-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-300 rounded">
                              W: {(needsWantsData.wants/totalCat*100).toFixed(0)}%
                            </span>
                          )}
                          {needsWantsData.investment > 0 && (
                            <span className="text-xs px-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300 rounded">
                              I: {(needsWantsData.investment/totalCat*100).toFixed(0)}%
                            </span>
                          )}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          
          <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="p-3 bg-gray-50 dark:bg-gray-700 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Total Spending</div>
              <div className="font-bold text-xl">‚Çπ{totalSpending.toFixed(2)}</div>
            </div>
            <div className="p-3 bg-gray-50 dark:bg-gray-700 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Categories with Overspending</div>
              <div className="font-bold text-xl text-red-500">
                {allCategories.filter(cat => {
                  const spent = categorySpending[cat] || 0;
                  const budget = categoryBudgets[cat] || 0;
                  return spent > budget && budget > 0;
                }).length}
              </div>
            </div>
            <div className="p-3 bg-gray-50 dark:bg-gray-700 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Budget Utilization</div>
              <div className="font-bold text-xl">
                {totalSpending > 0 && Object.values(categoryBudgets).reduce((a, b) => a + b, 0) > 0 
                  ? ((totalSpending / Object.values(categoryBudgets).reduce((a, b) => a + b, 0)) * 100).toFixed(1)
                  : 0}%
              </div>
            </div>
          </div>
        </div>
      );
    }

    function BudgetCompletionVisualization({ transactions, budgets, selectedMonth }) {
      const categories = [...new Set(transactions.map(t => t.category))].filter(cat => cat.toLowerCase() !== "income");
      
      const totalBudget = categories.reduce((sum, cat) => sum + (budgets[cat] || 0), 0);
      const totalSpent = categories.reduce((sum, cat) => {
        const spent = transactions.filter(t => t.category === cat).reduce((s, t) => s + t.amount, 0);
        return sum + spent;
      }, 0);
      
      const needsTotal = transactions.filter(tx => tx.necessity === "Needs").reduce((sum, tx) => sum + tx.amount, 0);
      const wantsTotal = transactions.filter(tx => tx.necessity === "Wants").reduce((sum, tx) => sum + tx.amount, 0);
      const investmentTotal = transactions.filter(tx => tx.necessity === "Investment").reduce((sum, tx) => sum + tx.amount, 0);
      
      const totalExpenses = needsTotal + wantsTotal + investmentTotal;

      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h2 className="font-semibold text-lg mb-3">üìã Budget Completion Dashboard</h2>
          <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
            {selectedMonth === "all" ? "All Time Overview" : `Month: ${selectedMonth}`}
          </p>
          
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Total Budget</div>
              <div className="font-bold text-2xl">‚Çπ{totalBudget.toFixed(2)}</div>
            </div>
            <div className="p-4 bg-green-50 dark:bg-green-900/20 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Total Spent</div>
              <div className="font-bold text-2xl">‚Çπ{totalSpent.toFixed(2)}</div>
              <div className="text-sm">{totalBudget > 0 ? ((totalSpent/totalBudget)*100).toFixed(1) : 0}% utilized</div>
            </div>
            <div className="p-4 bg-purple-50 dark:bg-purple-900/20 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Needs Total</div>
              <div className="font-bold text-2xl">‚Çπ{needsTotal.toFixed(2)}</div>
              <div className="text-sm">{totalExpenses > 0 ? ((needsTotal/totalExpenses)*100).toFixed(1) : 0}% of expenses</div>
            </div>
            <div className="p-4 bg-orange-50 dark:bg-orange-900/20 rounded">
              <div className="text-sm text-gray-600 dark:text-gray-400">Wants Total</div>
              <div className="font-bold text-2xl">‚Çπ{wantsTotal.toFixed(2)}</div>
              <div className="text-sm">{totalExpenses > 0 ? ((wantsTotal/totalExpenses)*100).toFixed(1) : 0}% of expenses</div>
            </div>
          </div>
          
          <div className="mb-4">
            <h3 className="font-medium mb-2">Budget vs Actual by Category</h3>
            <div className="space-y-2">
              {categories.map(cat => {
                const spent = transactions.filter(t => t.category === cat).reduce((sum, t) => sum + t.amount, 0);
                const budget = budgets[cat] || 0;
                const percentage = budget > 0 ? (spent / budget * 100) : 0;
                
                return (
                  <div key={cat} className="space-y-1">
                    <div className="flex justify-between text-sm">
                      <span>{cat}</span>
                      <span>‚Çπ{spent.toFixed(2)} / ‚Çπ{budget.toFixed(2)} ({percentage.toFixed(1)}%)</span>
                    </div>
                    <div className="w-full bg-gray-200 dark:bg-gray-700 rounded h-2">
                      <div 
                        className="h-2 rounded" 
                        style={{ 
                          width: `${Math.min(100, percentage)}%`,
                          backgroundColor: percentage > 100 ? '#EF4444' : percentage > 80 ? '#F59E0B' : '#10B981'
                        }}
                      ></div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    function PieChartComponent({ transactions, selectedMonth }) {
      const chartRef = React.useRef(null);
      const chartInstance = React.useRef(null);
      
      useEffect(() => {
        if (chartRef.current) {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
          
          const categories = {};
          transactions.forEach(t => {
            if (t.category.toLowerCase() !== "income") {
              categories[t.category] = (categories[t.category] || 0) + t.amount;
            }
          });
          
          const ctx = chartRef.current.getContext('2d');
          chartInstance.current = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: Object.keys(categories),
              datasets: [{
                data: Object.values(categories),
                backgroundColor: ["#4B7BEC", "#2E7D32", "#F9A825", "#e57373", "#ba68c8", "#64b5f6", "#FF8A65", "#4DB6AC", "#FFB74D", "#7986CB"]
              }]
            },
            options: {
              responsive: true,
              plugins: { 
                legend: { position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.raw || 0;
                      const total = Object.values(categories).reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return `${label}: ‚Çπ${value.toFixed(2)} (${percentage}%)`;
                    }
                  }
                },
                title: {
                  display: true,
                  text: selectedMonth === "all" ? "All Time Expense Breakdown" : `Expense Breakdown for ${selectedMonth}`
                }
              }
            }
          });
        }
        
        return () => {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
        };
      }, [transactions, selectedMonth]);
      
      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h2 className="font-semibold text-lg mb-2">Expense Breakdown by Category</h2>
          <canvas ref={chartRef} id="expensePie"></canvas>
        </div>
      );
    }

    function TransactionTable({ transactions, onDelete, onEdit, monthFilter, setMonthFilter, availableMonths, currentUser }) {
      const [editingRow, setEditingRow] = useState(null);
      const [editForm, setEditForm] = useState({});
      
      const handleEditClick = (tx, index) => {
        setEditingRow(index);
        setEditForm({ ...tx });
      };
      
      const handleEditChange = (field, value) => {
        setEditForm({ ...editForm, [field]: value });
      };

      const handleEditPersonChange = (personIndex, field, value) => {
        const group = editForm.groupDetails || { people: [] };
        const people = (group.people || []).map(p => ({ ...p }));
        if (!people[personIndex]) return;
        people[personIndex] = { ...people[personIndex], [field]: field === 'amount' ? (parseFloat(value) || 0) : value };
        const newGroup = { ...group, people };
        setEditForm({ ...editForm, groupDetails: newGroup });
      };

      const handleAddEditPerson = () => {
        const group = editForm.groupDetails || { people: [] };
        const newPerson = { id: Date.now(), name: `Person ${ (group.people || []).length + 1 }`, amount: 0, includeMe: false, isCustomName: true };
        const newGroup = { ...group, people: [...(group.people || []), newPerson] };
        setEditForm({ ...editForm, groupDetails: newGroup });
      };
      
      const handleSaveEdit = () => {
        onEdit(editForm);
        setEditingRow(null);
        setEditForm({});
      };
      
      const handleCancelEdit = () => {
        setEditingRow(null);
        setEditForm({});
      };
      
      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow overflow-auto">
          <div className="flex justify-between items-center mb-3">
            <h2 className="font-semibold text-lg">Transaction Log</h2>
            <select 
              value={monthFilter} 
              onChange={(e) => setMonthFilter(e.target.value)}
              className="p-2 rounded bg-gray-100 dark:bg-gray-700 text-sm"
            >
              <option value="all">All Months</option>
              {availableMonths.map(month => (
                <option key={month} value={month}>
                  {new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                </option>
              ))}
            </select>
          </div>
          
          {transactions.length === 0 ? (
            <p className="text-gray-500 dark:text-gray-400 p-2">No transactions for selected month</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="table-auto w-full text-left">
                <thead>
                  <tr className="border-b dark:border-gray-700">
                    <th className="p-2">Date</th>
                    <th className="p-2">Description</th>
                    <th className="p-2">Category</th>
                    <th className="p-2">Amount</th>
                    <th className="p-2">Necessity</th>
                    <th className="p-2">Details</th>
                    <th className="p-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {transactions.map((tx, idx) => (
                    <tr key={tx.id || idx} className="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                      {editingRow === idx ? (
                        <>
                          <td className="p-2">
                            <input
                              type="date"
                              value={editForm.date}
                              onChange={(e) => handleEditChange('date', e.target.value)}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="p-2">
                            <input
                              type="text"
                              value={editForm.description}
                              onChange={(e) => handleEditChange('description', e.target.value)}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="p-2">
                            <select
                              value={editForm.category}
                              onChange={(e) => handleEditChange('category', e.target.value)}
                              className="w-full p-1 border rounded"
                            >
                              {["Rent & Utilities","Foods & cravings","Daily Living","Travel & Transport","Fitness & Health","Family Support","Entertainment & Subscriptions","Personal Care & Shopping","Investments","Personal EMIs","Emergency Funds"].map(cat => (
                                <option key={cat} value={cat}>{cat}</option>
                              ))}
                            </select>
                          </td>
                          <td className="p-2">
                            <input
                              type="number"
                              step="0.01"
                              value={editForm.amount}
                              onChange={(e) => handleEditChange('amount', parseFloat(e.target.value))}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="p-2">
                            <select
                              value={editForm.necessity}
                              onChange={(e) => handleEditChange('necessity', e.target.value)}
                              className="w-full p-1 border rounded"
                            >
                              <option value="Needs">Needs</option>
                              <option value="Wants">Wants</option>
                              <option value="Investment">Investment</option>
                            </select>
                          </td>
                          <td className="p-2">
                            <div>
                              <label className="block text-xs mb-1">Group Payment</label>
                              <select
                                value={editForm.groupPay || "No"}
                                onChange={(e) => {
                                  const val = e.target.value;
                                  handleEditChange('groupPay', val);
                                  if (val === 'Yes' && !editForm.groupDetails) {
                                    setEditForm({
                                      ...editForm,
                                      groupDetails: {
                                        splitType: 'equal',
                                        includeMe: true,
                                        people: [
                                          { id: Date.now() + 1, name: currentUser || 'You', amount: 0, includeMe: true, isCustomName: false }
                                        ]
                                      }
                                    });
                                  }
                                }}
                                className="w-full p-1 border rounded"
                              >
                                <option value="No">No - Personal</option>
                                <option value="Yes">Yes - Shared</option>
                              </select>

                              {editForm.groupPay === "Yes" && editForm.groupDetails && (
                                <div className="mt-2 space-y-2 p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                  {(editForm.groupDetails.people || []).map((person, pIdx) => (
                                    <div key={person.id} className="flex gap-2 items-center">
                                      <input type="text" value={person.name} onChange={(e) => handleEditPersonChange(pIdx, 'name', e.target.value)} className="flex-1 p-1 border rounded" />
                                      <input type="number" step="0.01" value={person.amount} onChange={(e) => handleEditPersonChange(pIdx, 'amount', e.target.value)} className="w-24 p-1 border rounded" />
                                    </div>
                                  ))}
                                  <div className="flex gap-2">
                                    <button type="button" onClick={handleAddEditPerson} className="px-2 py-1 bg-green-500 text-white rounded">Add Person</button>
                                  </div>
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="p-2">
                            <div className="flex gap-1">
                              <button 
                                onClick={handleSaveEdit}
                                className="px-2 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                              >
                                Save
                              </button>
                              <button 
                                onClick={handleCancelEdit}
                                className="px-2 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600"
                              >
                                Cancel
                              </button>
                            </div>
                          </td>
                        </>
                      ) : (
                        <>
                          <td className="p-2">{tx.date}</td>
                          <td className="p-2">
                            <div className="font-medium">{tx.description}</div>
                            {tx.groupPay === "Yes" && tx.groupDetails && (
                              <div className="text-xs text-blue-600 dark:text-blue-400 mt-1">
                                <div>{tx.groupDetails.people.length} people</div>
                                {tx.groupDetails.splitType === 'equal' ? (
                                  <div>Equal split: ‚Çπ{(tx.amount / tx.groupDetails.people.length).toFixed(2)} each</div>
                                ) : (
                                  <div>Custom split</div>
                                )}
                              </div>
                            )}
                          </td>
                          <td className="p-2">
                            <div>{tx.category}</div>
                            <div className={`text-xs px-1 rounded ${tx.necessity === 'Needs' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300' : tx.necessity === 'Wants' ? 'bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-300' : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300'}`}>
                              {tx.necessity}
                            </div>
                          </td>
                          <td className="p-2 font-medium text-green-600 dark:text-green-400">‚Çπ{tx.amount.toFixed(2)}</td>
                          <td className="p-2">
                            <span className={`text-xs px-2 py-1 rounded ${tx.necessity === 'Needs' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300' : tx.necessity === 'Wants' ? 'bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-300' : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300'}`}>
                              {tx.necessity}
                            </span>
                          </td>
                          <td className="p-2">
                            {tx.groupPay === "Yes" && tx.groupDetails ? (
                              <div className="text-xs">
                                <div className={`px-2 py-1 rounded mb-1 ${tx.groupPay === 'Yes' ? 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300'}`}>
                                  Group: {tx.groupDetails.splitType}
                                </div>
                                <div className="text-gray-600 dark:text-gray-400">
                                  Includes you: {tx.groupDetails.includeMe ? 'Yes' : 'No'}
                                </div>
                              </div>
                            ) : (
                              <span className={`text-xs px-2 py-1 rounded ${tx.groupPay === 'Yes' ? 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300'}`}>
                                Personal
                              </span>
                            )}
                          </td>
                          <td className="p-2">
                            <div className="flex gap-1">
                              <button 
                                onClick={() => handleEditClick(tx, idx)}
                                className="px-2 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
                              >
                                Edit
                              </button>
                              <button 
                                onClick={() => onDelete(idx)} 
                                className="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                              >
                                Delete
                              </button>
                            </div>
                          </td>
                        </>
                      )}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
          
          {transactions.length > 0 && (
            <div className="mt-3 p-3 bg-gray-50 dark:bg-gray-700 rounded text-sm">
              <div className="font-medium">Month Summary:</div>
              <div>Total Transactions: {transactions.length}</div>
              <div>Total Amount: ‚Çπ{transactions.reduce((sum, tx) => sum + tx.amount, 0).toFixed(2)}</div>
              <div>Group Payments: {transactions.filter(tx => tx.groupPay === "Yes").length}</div>
            </div>
          )}
        </div>
      );
    }

    function LoginForm({ onLogin }) {
      const [mode, setMode] = useState("email");
      const [input, setInput] = useState("");

      const validateInput = () => {
        if (mode === "email") {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(input);
        } else {
          return /^[a-zA-Z0-9]{3,20}$/.test(input);
        }
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!validateInput()) {
          alert("Invalid input format.");
          return;
        }
        localStorage.setItem("currentUser", input);
        onLogin(input);
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-900">
          <form onSubmit={handleSubmit} className="p-6 max-w-md w-full mx-4 bg-white dark:bg-gray-800 shadow rounded space-y-4">
            <h2 className="text-xl font-semibold text-center">Login to MoneyWise</h2>
            <div className="flex gap-4 justify-center">
              <label className="flex items-center"><input type="radio" checked={mode === "email"} onChange={() => setMode("email")} className="mr-2" /> Email</label>
              <label className="flex items-center"><input type="radio" checked={mode === "username"} onChange={() => setMode("username")} className="mr-2" /> Guest Username</label>
            </div>
            <input
              type="text"
              placeholder={mode === "email" ? "example@domain.com" : "Guest123"}
              value={input}
              onChange={(e) => setInput(e.target.value)}
              className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700"
              required
            />
            <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Log In</button>
          </form>
        </div>
      );
    }

    // ============ INSIGHTS & ADVANCED ANALYTICS FUNCTIONS ============
    function calculateInsights(transactions, budgets, customIncome) {
      const filteredTx = transactions.filter(tx => tx.category.toLowerCase() !== "income");
      
      // Hidden Leaks - Small recurring expenses
      const hiddenLeaks = {};
      filteredTx.forEach(tx => {
        if (tx.amount < 500) {
          hiddenLeaks[tx.description] = (hiddenLeaks[tx.description] || 0) + tx.amount;
        }
      });
      const leaksList = Object.entries(hiddenLeaks).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const leaksTotal = leaksList.reduce((sum, [_, amount]) => sum + amount, 0);
      
      // Monthly Trend - % change
      const monthlyData = {};
      filteredTx.forEach(tx => {
        const date = new Date(tx.date);
        const month = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        monthlyData[month] = (monthlyData[month] || 0) + tx.amount;
      });
      const sortedMonths = Object.keys(monthlyData).sort();
      let monthlyTrendPercent = 0;
      if (sortedMonths.length > 1) {
        const prev = monthlyData[sortedMonths[sortedMonths.length - 2]];
        const curr = monthlyData[sortedMonths[sortedMonths.length - 1]];
        monthlyTrendPercent = prev > 0 ? ((curr - prev) / prev * 100) : 0;
      }
      
      // Category Trends - Top 3 movers
      const categoryMonthly = {};
      filteredTx.forEach(tx => {
        const date = new Date(tx.date);
        const month = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        if (!categoryMonthly[tx.category]) categoryMonthly[tx.category] = {};
        categoryMonthly[tx.category][month] = (categoryMonthly[tx.category][month] || 0) + tx.amount;
      });
      
      const categoryTrends = Object.entries(categoryMonthly).map(([cat, months]) => {
        const sortedMonthKeys = Object.keys(months).sort();
        if (sortedMonthKeys.length < 2) return null;
        const prev = months[sortedMonthKeys[sortedMonthKeys.length - 2]];
        const curr = months[sortedMonthKeys[sortedMonthKeys.length - 1]];
        const change = prev > 0 ? ((curr - prev) / prev * 100) : 0;
        return { category: cat, change, prev, curr };
      }).filter(Boolean).sort((a, b) => Math.abs(b.change) - Math.abs(a.change)).slice(0, 3);
      
      // Lifestyle Inflation
      const monthlyExpenses = Object.values(monthlyData).sort();
      const avgMonthly = monthlyExpenses.reduce((a, b) => a + b, 0) / monthlyExpenses.length;
      const latestMonth = monthlyExpenses[monthlyExpenses.length - 1];
      const lifestyleStatus = latestMonth > avgMonthly * 1.15 ? 'WARNING' : 'OK';
      
      // Budget Usage - Per-category progress bars
      const totalIncome = customIncome + transactions.filter(tx => tx.category.toLowerCase() === "income").reduce((sum, tx) => sum + tx.amount, 0);
      const budgetUsage = Object.entries(budgets || {}).map(([cat, budget]) => {
        const spent = filteredTx.filter(tx => tx.category === cat).reduce((sum, tx) => sum + tx.amount, 0);
        return { category: cat, budget, spent, percent: budget > 0 ? (spent / budget * 100) : 0 };
      });
      
      // Overspend Prediction
      const totalBudget = Object.values(budgets || {}).reduce((a, b) => a + b, 0);
      const totalSpent = filteredTx.reduce((sum, tx) => sum + tx.amount, 0);
      let overspendStatus = 'GREEN';
      if (totalBudget > 0 && totalSpent > totalBudget * 0.9) overspendStatus = 'YELLOW';
      if (totalBudget > 0 && totalSpent > totalBudget) overspendStatus = 'RED';
      
      // Pattern Detection - Days/merchants analysis
      const dayOfWeek = {};
      const merchantAnalysis = {};
      filteredTx.forEach(tx => {
        const date = new Date(tx.date);
        const day = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
        dayOfWeek[day] = (dayOfWeek[day] || 0) + tx.amount;
        merchantAnalysis[tx.description] = (merchantAnalysis[tx.description] || 0) + 1;
      });
      const busiestDay = Object.keys(dayOfWeek).reduce((a, b) => dayOfWeek[a] > dayOfWeek[b] ? a : b, 'N/A');
      const topMerchant = Object.keys(merchantAnalysis).reduce((a, b) => merchantAnalysis[a] > merchantAnalysis[b] ? a : b, 'N/A');
      
      // Savings Rate
      const totalExpensesAll = filteredTx.reduce((sum, tx) => sum + tx.amount, 0);
      const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpensesAll) / totalIncome * 100) : 0;
      
      // Savings Streak - Day counter
      const recentDays = {};
      filteredTx.forEach(tx => {
        const date = tx.date;
        recentDays[date] = true;
      });
      let streak = 0;
      const today = new Date();
      for (let i = 0; i < 365; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        if (recentDays[dateStr]) {
          streak++;
        } else if (i > 0) {
          break;
        }
      }
      
      // Daily Average
      const daysWithTransactions = Object.keys(recentDays).length || 1;
      const dailyAverage = totalExpensesAll / daysWithTransactions;
      const runwayDays = totalIncome > 0 ? Math.floor((totalIncome - totalExpensesAll) / dailyAverage) : 0;
      
      // Expense Ratio
      const needsExpense = filteredTx.filter(tx => tx.necessity === 'Needs').reduce((sum, tx) => sum + tx.amount, 0);
      const expenseRatio = totalIncome > 0 ? (needsExpense / totalIncome * 100) : 0;
      
      // Subscriptions
      const subscriptions = filteredTx.filter(tx => 
        tx.description.toLowerCase().includes('sub') || 
        tx.description.toLowerCase().includes('netflix') ||
        tx.description.toLowerCase().includes('spotify') ||
        tx.description.toLowerCase().includes('premium')
      );
      
      // EMI Stress
      const emiExpense = filteredTx.filter(tx => tx.category === 'Personal EMIs').reduce((sum, tx) => sum + tx.amount, 0);
      const emiStress = totalIncome > 0 ? (emiExpense / totalIncome * 100) : 0;
      let emiStatus = 'SAFE';
      if (emiStress > 30) emiStatus = 'RISK';
      else if (emiStress > 20) emiStatus = 'MODERATE';
      
      // Financial Score
      const scoreFactors = [
        savingsRate > 20 ? 20 : savingsRate > 10 ? 10 : 0,
        totalBudget > 0 ? 15 : 0,
        totalSpent <= totalBudget ? 20 : totalSpent <= totalBudget * 1.1 ? 10 : 0,
        expenseRatio < 50 ? 15 : expenseRatio < 70 ? 8 : 0,
        emiStatus === 'SAFE' ? 15 : emiStatus === 'MODERATE' ? 8 : 0,
        subscriptions.length < 3 ? 15 : 8
      ];
      const healthScore = Math.min(100, scoreFactors.reduce((a, b) => a + b, 0));
      
      return {
        hiddenLeaks: leaksList,
        leaksTotal,
        monthlyTrendPercent,
        categoryTrends,
        lifestyleStatus,
        budgetUsage,
        overspendStatus,
        busiestDay,
        topMerchant,
        savingsRate: savingsRate.toFixed(1),
        streak,
        dailyAverage: dailyAverage.toFixed(2),
        runwayDays,
        expenseRatio: expenseRatio.toFixed(1),
        subscriptions,
        emiStress: emiStress.toFixed(1),
        emiStatus,
        healthScore: Math.round(healthScore),
        needsExpense,
        totalSpent,
        totalIncome,
        totalBudget
      };
    }

    function InsightsPanel({ transactions, budgets, customIncome }) {
      const [expandedCard, setExpandedCard] = useState(null);
      const [refreshTrigger, setRefreshTrigger] = useState(0);
      
      useEffect(() => {
        setRefreshTrigger(prev => prev + 1);
      }, [transactions, budgets, customIncome]);
      
      const insights = calculateInsights(transactions, budgets, customIncome);
      
      const InsightCard = ({ title, icon, children, id }) => (
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg border-l-4 border-blue-500 overflow-hidden hover:shadow-xl transition-all duration-300 hover:border-blue-600 transform hover:scale-100 group">
          <button
            onClick={(e) => { e.preventDefault(); setExpandedCard(expandedCard === id ? null : id); }}
            className="w-full p-4 flex items-center justify-between hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 dark:hover:from-blue-900/20 dark:hover:to-indigo-900/20 transition-all duration-300"
          >
            <div className="flex items-center gap-3">
              <span className="text-2xl group-hover:scale-110 transition-transform duration-300">{icon}</span>
              <h3 className="font-semibold text-lg group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-300">{title}</h3>
            </div>
            <span className="text-gray-400 group-hover:text-blue-500 transition-all duration-300 transform group-hover:scale-125">{expandedCard === id ? '‚ñº' : '‚ñ∂'}</span>
          </button>
          
          {expandedCard === id && (
            <div className="p-4 border-t dark:border-gray-700 bg-gradient-to-b from-gray-50 to-white dark:from-gray-700/50 dark:to-gray-800 animate-in fade-in slide-in-from-top-2 duration-300">
              {children}
            </div>
          )}
        </div>
      );
      
      return (
        <div className="space-y-3">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div className="hover-lift bg-gradient-to-br from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 p-4 rounded-lg border-2 border-transparent hover:border-red-300 dark:hover:border-red-600 transition-all duration-300 cursor-pointer">
                <div className="text-sm font-medium text-gray-600 dark:text-gray-400"><i className="fas fa-droplet text-gray-700 dark:text-gray-500 mr-2"></i>Hidden Leaks</div>
              <div className="text-3xl font-bold text-red-600 dark:text-red-400 mt-2">‚Çπ{insights.leaksTotal.toFixed(2)}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">{insights.hiddenLeaks.length} recurring expenses</div>
            </div>
            
            <div className="hover-lift bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 p-4 rounded-lg border-2 border-transparent hover:border-blue-300 dark:hover:border-blue-600 transition-all duration-300 cursor-pointer">
                <div className="text-sm font-medium text-gray-600 dark:text-gray-400"><i className="fas fa-chart-bar text-gray-700 dark:text-gray-500 mr-2"></i>Monthly Trend</div>
              <div className="text-3xl font-bold mt-2">
                <span className={insights.monthlyTrendPercent >= 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}>
                  {insights.monthlyTrendPercent >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(insights.monthlyTrendPercent).toFixed(1)}%
                </span>
              </div>
              <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">vs previous month</div>
            </div>
            
            <div className="hover-lift bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 p-4 rounded-lg border-2 border-transparent hover:border-purple-300 dark:hover:border-purple-600 transition-all duration-300 cursor-pointer">
                <div className="text-sm font-medium text-gray-600 dark:text-gray-400"><i className="fas fa-star text-gray-700 dark:text-gray-500 mr-2"></i>Financial Health</div>
              <div className="text-3xl font-bold text-purple-600 dark:text-purple-400 mt-2">{insights.healthScore}<span className="text-lg">/100</span></div>
              <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Overall score</div>
            </div>
          </div>
          
      
            <InsightCard title="Hidden Leaks" icon={<i className="fas fa-magnifying-glass text-gray-700 dark:text-gray-400"></i>} id="leaks">
            <div className="space-y-2">
              {insights.hiddenLeaks.length > 0 ? (
                insights.hiddenLeaks.map(([desc, amount], idx) => (
                  <div key={idx} className="flex justify-between p-2 bg-white dark:bg-gray-800 rounded">
                    <span>{desc}</span>
                    <span className="font-semibold text-red-600">‚Çπ{amount.toFixed(2)}</span>
                  </div>
                ))
              ) : (
                <p className="text-gray-500">No small recurring expenses detected</p>
              )}
              <div className="mt-3 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded text-sm">
                 <i className="fas fa-lightbulb text-gray-700 dark:text-gray-400 mr-2"></i>Tip: These small expenses add up! Consider reducing or eliminating some.
              </div>
            </div>
          </InsightCard>
          
          
            <InsightCard title="Monthly Trend" icon={<i className="fas fa-chart-bar text-gray-700 dark:text-gray-400"></i>} id="trend">
            <div className="text-center">
              <div className="text-3xl font-bold my-4">
                <span className={insights.monthlyTrendPercent >= 0 ? 'text-red-600' : 'text-green-600'}>
                  {insights.monthlyTrendPercent >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(insights.monthlyTrendPercent).toFixed(1)}%
                </span>
              </div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                {insights.monthlyTrendPercent > 0 ? 'Your expenses are increasing' : 'Your expenses are decreasing'}
              </p>
            </div>
          </InsightCard>
          
        
            <InsightCard title="Category Trends" icon={<i className="fas fa-chart-line text-gray-700 dark:text-gray-400"></i>} id="cattrends">
            <div className="space-y-2">
              {insights.categoryTrends.length > 0 ? (
                insights.categoryTrends.map((trend, idx) => (
                  <div key={idx} className="p-2 bg-white dark:bg-gray-800 rounded">
                    <div className="flex justify-between">
                      <span>{trend.category}</span>
                      <span className={trend.change >= 0 ? 'text-red-600' : 'text-green-600'}>
                        {trend.change >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(trend.change).toFixed(1)}%
                      </span>
                    </div>
                    <div className="text-xs text-gray-500">‚Çπ{trend.prev.toFixed(0)} ‚Üí ‚Çπ{trend.curr.toFixed(0)}</div>
                  </div>
                ))
              ) : (
                <p className="text-gray-500">Not enough data to analyze trends</p>
              )}
            </div>
          </InsightCard>
          
          
            <InsightCard title="Lifestyle Inflation" icon={insights.lifestyleStatus === 'OK' ? <i className="fas fa-check text-gray-700 dark:text-gray-400"></i> : <i className="fas fa-exclamation-triangle text-gray-700 dark:text-gray-400"></i>} id="lifestyle">
            <div className="text-center">
              <div className={`text-3xl font-bold my-4 ${insights.lifestyleStatus === 'OK' ? 'text-green-600' : 'text-red-600'}`}>
                {insights.lifestyleStatus}
              </div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                {insights.lifestyleStatus === 'OK' 
                  ? 'Your spending is stable' 
                  : 'Your spending has increased significantly this month'}
              </p>
            </div>
          </InsightCard>
          
      
            <InsightCard title="Budget Usage" icon={<i className="fas fa-bullseye text-gray-700 dark:text-gray-400"></i>} id="budget">
            <div className="space-y-3">
              {insights.budgetUsage.length > 0 ? (
                insights.budgetUsage.map((item, idx) => (
                  <div key={idx}>
                    <div className="flex justify-between text-sm mb-1">
                      <span>{item.category}</span>
                      <span>{item.percent.toFixed(1)}%</span>
                    </div>
                    <div className="w-full bg-gray-300 dark:bg-gray-600 rounded h-2">
                      <div 
                        className="h-2 rounded" 
                        style={{ 
                          width: `${Math.min(100, item.percent)}%`,
                          backgroundColor: item.percent > 100 ? '#EF4444' : item.percent > 80 ? '#F59E0B' : '#10B981'
                        }}
                      ></div>
                    </div>
                  </div>
                ))
              ) : (
                <p className="text-gray-500">No budget data available</p>
              )}
            </div>
          </InsightCard>
          
         
            <InsightCard title="Overspend Prediction" icon={insights.overspendStatus === 'RED' ? <i className="fas fa-circle text-gray-700 dark:text-gray-400"></i> : insights.overspendStatus === 'YELLOW' ? <i className="fas fa-circle text-gray-700 dark:text-gray-400"></i> : <i className="fas fa-circle text-gray-700 dark:text-gray-400"></i>} id="overspend">
            <div className="text-center">
              <div className="text-3xl font-bold my-4">{insights.overspendStatus}</div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                Spent: ‚Çπ{insights.totalSpent.toFixed(2)} / Budget: ‚Çπ{insights.totalBudget.toFixed(2)}
              </p>
            </div>
          </InsightCard>
          
        
            <InsightCard title="Pattern Detection" icon={<i className="fas fa-arrows-rotate text-gray-700 dark:text-gray-400"></i>} id="patterns">
            <div className="space-y-2">
              <div className="p-2 bg-white dark:bg-gray-800 rounded">
                <div className="text-sm text-gray-600">Busiest Day</div>
                <div className="font-semibold">{insights.busiestDay}</div>
              </div>
              <div className="p-2 bg-white dark:bg-gray-800 rounded">
                <div className="text-sm text-gray-600">Top Merchant</div>
                <div className="font-semibold truncate">{insights.topMerchant}</div>
              </div>
            </div>
          </InsightCard>
          
        
            <InsightCard title="Savings Rate" icon={<i className="fas fa-wallet text-gray-700 dark:text-gray-400"></i>} id="savings">
            <div className="text-center">
              <div className="text-3xl font-bold my-4 text-green-600">{insights.savingsRate}%</div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                You're saving {insights.savingsRate}% of your income
              </p>
            </div>
          </InsightCard>
          
      
            <InsightCard title="Savings Streak" icon={<i className="fas fa-fire text-gray-700 dark:text-gray-400"></i>} id="streak">
            <div className="text-center">
              <div className="text-4xl font-bold my-4">{insights.streak}</div>
              <p className="text-sm text-gray-600 dark:text-gray-400">days of tracked spending</p>
            </div>
          </InsightCard>
          
            <InsightCard title="Daily Average" icon={<i className="fas fa-calendar text-gray-700 dark:text-gray-400"></i>} id="daily">
            <div className="text-center">
              <div className="text-3xl font-bold my-4">‚Çπ{insights.dailyAverage}</div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                Average daily spending
              </p>
              <div className="mt-3 p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-sm">
                Runway: {insights.runwayDays} days at current rate
              </div>
            </div>
          </InsightCard>
          
            <InsightCard title="Expense Ratio" icon={<i className="fas fa-chart-pie text-gray-700 dark:text-gray-400"></i>} id="ratio">
            <div className="text-center">
              <div className="text-3xl font-bold my-4">{insights.expenseRatio}%</div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                Fixed costs vs income
              </p>
            </div>
          </InsightCard>
          
            <InsightCard title="Subscriptions" icon={<i className="fas fa-gift text-gray-700 dark:text-gray-400"></i>} id="subs">
            <div className="space-y-2">
              {insights.subscriptions.length > 0 ? (
                insights.subscriptions.map((sub, idx) => (
                  <div key={idx} className="p-2 bg-white dark:bg-gray-800 rounded flex justify-between">
                    <span>{sub.description}</span>
                    <span className="font-semibold">‚Çπ{sub.amount.toFixed(2)}</span>
                  </div>
                ))
              ) : (
                <p className="text-gray-500">No subscriptions detected</p>
              )}
            </div>
          </InsightCard>
          
            <InsightCard title="EMI Stress" icon={insights.emiStatus === 'SAFE' ? <i className="fas fa-check text-gray-700 dark:text-gray-400"></i> : insights.emiStatus === 'MODERATE' ? <i className="fas fa-exclamation-triangle text-gray-700 dark:text-gray-400"></i> : <i className="fas fa-circle text-gray-700 dark:text-gray-400"></i>} id="emi">
            <div className="text-center">
              <div className={`text-3xl font-bold my-4 ${insights.emiStatus === 'SAFE' ? 'text-green-600' : insights.emiStatus === 'MODERATE' ? 'text-yellow-600' : 'text-red-600'}`}>
                {insights.emiStatus}
              </div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                {insights.emiStress}% of income goes to EMIs
              </p>
            </div>
          </InsightCard>
        </div>
      );
    }

  
    function GoalsSystem() {
      const [goals, setGoals] = useState(() => {
        const saved = localStorage.getItem("moneywise_goals");
        return saved ? JSON.parse(saved) : [];
      });
      
      const [showForm, setShowForm] = useState(false);
      const [formData, setFormData] = useState({
        name: '',
        targetAmount: '',
        currentAmount: '',
        targetDate: '',
        type: 'savings', // savings or debt
        category: 'travel',
        priority: 'medium'
      });
      
      useEffect(() => {
        localStorage.setItem("moneywise_goals", JSON.stringify(goals));
      }, [goals]);
      
      const addGoal = (e) => {
        e.preventDefault();
        if (!formData.name || !formData.targetAmount || !formData.targetDate) {
          alert("Please fill all required fields");
          return;
        }
        
        const newGoal = {
          id: Date.now(),
          ...formData,
          targetAmount: parseFloat(formData.targetAmount),
          currentAmount: parseFloat(formData.currentAmount) || 0,
          createdAt: new Date().toISOString(),
          contributions: [],
          status: 'on-track'
        };
        
        setGoals([...goals, newGoal]);
        setFormData({
          name: '',
          targetAmount: '',
          currentAmount: '',
          targetDate: '',
          type: 'savings',
          category: 'travel',
          priority: 'medium'
        });
        setShowForm(false);
      };
      
      const updateGoalProgress = (goalId, amount) => {
        setGoals(goals.map(goal => {
          if (goal.id === goalId) {
            const newAmount = goal.currentAmount + parseFloat(amount);
            const contribution = {
              id: Date.now(),
              amount: parseFloat(amount),
              date: new Date().toISOString()
            };
            return {
              ...goal,
              currentAmount: Math.min(newAmount, goal.targetAmount),
              contributions: [...(goal.contributions || []), contribution]
            };
          }
          return goal;
        }));
      };
      
      const deleteGoal = (goalId) => {
        setGoals(goals.filter(goal => goal.id !== goalId));
      };
      
      const priorityColors = {
        low: 'bg-green-100 dark:bg-green-900/20 border-green-300',
        medium: 'bg-yellow-100 dark:bg-yellow-900/20 border-yellow-300',
        high: 'bg-red-100 dark:bg-red-900/20 border-red-300'
      };
      
      const typeEmoji = {
          savings: <i className="fas fa-piggy-bank text-gray-700 dark:text-gray-400"></i>,
          debt: <i className="fas fa-credit-card text-gray-700 dark:text-gray-400"></i>
      };
      
      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <div className="flex justify-between items-center mb-4">
            <h2 className="font-semibold text-lg"><i className="fas fa-bullseye text-gray-700 dark:text-gray-400 mr-2"></i>Goals System</h2>
            <button
              onClick={() => setShowForm(!showForm)}
              className="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
            >
              {showForm ? 'Cancel' : '+ New Goal'}
            </button>
          </div>
          
          {showForm && (
            <form onSubmit={addGoal} className="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">Goal Name *</label>
                  <input
                    type="text"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                    placeholder="e.g., Bali Trip"
                    className="w-full p-2 rounded bg-white dark:bg-gray-800 border"
                  />
                </div>
                <div>
                  <label className="block text-sm mb-1">Type</label>
                  <select
                    value={formData.type}
                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                    className="w-full p-2 rounded bg-white dark:bg-gray-800 border"
                  >
                    <option value="savings">Savings Goal</option>
                    <option value="debt">Debt Goal</option>
                  </select>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                  <label className="block text-sm mb-1">Target Amount (‚Çπ) *</label>
                  <input
                    type="number"
                    step="0.01"
                    value={formData.targetAmount}
                    onChange={(e) => setFormData({...formData, targetAmount: e.target.value})}
                    placeholder="50000"
                    className="w-full p-2 rounded bg-white dark:bg-gray-800 border"
                  />
                </div>
                <div>
                  <label className="block text-sm mb-1">Current Amount (‚Çπ)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={formData.currentAmount}
                    onChange={(e) => setFormData({...formData, currentAmount: e.target.value})}
                    placeholder="0"
                    className="w-full p-2 rounded bg-white dark:bg-gray-800 border"
                  />
                </div>
                <div>
                  <label className="block text-sm mb-1">Target Date *</label>
                  <input
                    type="date"
                    value={formData.targetDate}
                    onChange={(e) => setFormData({...formData, targetDate: e.target.value})}
                    className="w-full p-2 rounded bg-white dark:bg-gray-800 border"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">Category</label>
                  <select
                    value={formData.category}
                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                    className="w-full p-2 rounded bg-white dark:bg-gray-800 border"
                  >
                    <option value="travel">Travel</option>
                    <option value="education">Education</option>
                    <option value="home">Home</option>
                    <option value="vehicle">Vehicle</option>
                    <option value="emergency">Emergency Fund</option>
                    <option value="retirement">Retirement</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm mb-1">Priority</label>
                  <select
                    value={formData.priority}
                    onChange={(e) => setFormData({...formData, priority: e.target.value})}
                    className="w-full p-2 rounded bg-white dark:bg-gray-800 border"
                  >
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                  </select>
                </div>
              </div>
              
              <button type="submit" className="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                Create Goal
              </button>
            </form>
          )}
          
          {goals.length === 0 ? (
            <p className="text-gray-500 dark:text-gray-400 text-center py-8">
              No goals yet. Create your first goal to get started! üéØ
            </p>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {goals.map(goal => {
                const progress = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount * 100) : 0;
                const targetDate = new Date(goal.targetDate);
                const today = new Date();
                const daysLeft = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
                const monthsLeft = Math.ceil(daysLeft / 30);
                const monthlyTarget = monthsLeft > 0 ? (goal.targetAmount - goal.currentAmount) / monthsLeft : 0;
                
                return (
                  <div key={goal.id} className={`p-4 rounded-lg border-2 ${priorityColors[goal.priority]}`}>
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex items-center gap-2">
                        <span className="text-2xl">{typeEmoji[goal.type]}</span>
                        <div>
                          <h3 className="font-semibold">{goal.name}</h3>
                          <p className="text-xs text-gray-600 dark:text-gray-400">{goal.category}</p>
                        </div>
                      </div>
                      <button
                        onClick={() => deleteGoal(goal.id)}
                        className="text-red-500 hover:text-red-700"
                      >
                        ‚úï
                      </button>
                    </div>
                    

                    <div className="flex justify-center my-4">
                      <svg width="120" height="120" className="transform -rotate-90">
                        <circle cx="60" cy="60" r="50" stroke="#e5e7eb" strokeWidth="8" fill="none" />
                        <circle
                          cx="60"
                          cy="60"
                          r="50"
                          stroke={progress > 100 ? '#10b981' : progress > 75 ? '#3b82f6' : '#f59e0b'}
                          strokeWidth="8"
                          fill="none"
                          strokeDasharray={`${(progress / 100) * 314} 314`}
                          strokeLinecap="round"
                        />
                        <text x="60" y="65" textAnchor="middle" className="fill-gray-800 dark:fill-gray-200 font-bold text-lg">
                          {Math.round(progress)}%
                        </text>
                      </svg>
                    </div>
                    
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span>Progress</span>
                        <span className="font-semibold">‚Çπ{goal.currentAmount.toFixed(0)} / ‚Çπ{goal.targetAmount.toFixed(0)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span>Time Left</span>
                        <span className="font-semibold">{daysLeft > 0 ? `${daysLeft} days` : 'Overdue'}</span>
                      </div>
                      <div className="flex justify-between">
                        <span>Monthly Target</span>
                        <span className="font-semibold">‚Çπ{monthlyTarget.toFixed(0)}</span>
                      </div>
                      
                      <div className="flex gap-2 mt-3">
                        <input
                          type="number"
                          step="100"
                          placeholder="Add amount"
                          id={`amount-${goal.id}`}
                          className="flex-1 p-1 rounded bg-white dark:bg-gray-800 border text-sm"
                        />
                        <button
                          onClick={() => {
                            const input = document.getElementById(`amount-${goal.id}`);
                            if (input.value) {
                              updateGoalProgress(goal.id, input.value);
                              input.value = '';
                            }
                          }}
                          className="px-2 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                        >
                          Add
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    function Footer() {
      // Footer removed as requested
      return null;
    }

    function Root() {
      const [currentUser, setCurrentUser] = React.useState(() => localStorage.getItem("currentUser"));

      const logoutUser = () => {
        localStorage.removeItem("currentUser");
        setCurrentUser(null);
      };

      return currentUser ? <App currentUser={currentUser} logoutUser={logoutUser} /> : <LoginForm onLogin={setCurrentUser} />;
    }

    ReactDOM.render(<Root />, document.getElementById("root"));
  </script>
</body>
</html>
