<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoneyWise</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    canvas { max-height: 300px; }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors">
  <div id="root"></div>

  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6.26.0/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App({ currentUser, logoutUser }) {
  const [manualIncome, setManualIncome] = useState(() => parseFloat(localStorage.getItem("manualIncome")) || 0);
      const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem("transactions")) || []);
      const [darkMode, setDarkMode] = useState(() => localStorage.getItem("theme") === "dark");
      const [filter, setFilter] = useState("monthly");
      const [budgets, setBudgets] = useState(() => JSON.parse(localStorage.getItem("budgets")) || {});

      useEffect(() => {
    localStorage.setItem("manualIncome", manualIncome);

        localStorage.setItem("transactions", JSON.stringify(transactions));
        localStorage.setItem("budgets", JSON.stringify(budgets));
      }, [transactions, budgets]);

      useEffect(() => {
        document.documentElement.classList.toggle("dark", darkMode);
        localStorage.setItem("theme", darkMode ? "dark" : "light");
      }, [darkMode]);

      function addTransaction(tx) {
        setTransactions([...transactions, tx]);
      }

      function deleteTransaction(index) {
        const newTx = [...transactions];
        newTx.splice(index, 1);
        setTransactions(newTx);
      }

      function exportToCSV() {
        let csv = "Date,Description,Category,Amount,Group Pay,Necessity\n";
        transactions.forEach(tx => {
          csv += `${tx.date},${tx.description},${tx.category},${tx.amount},${tx.groupPay},${tx.necessity}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        saveAs(blob, 'transactions.csv');
      }

      const calculatedIncome = transactions.filter(tx => tx.category.toLowerCase() === "income").reduce((acc, tx) => acc + tx.amount, 0);
  const totalIncome = manualIncome + calculatedIncome;

      function updateBudget(category, amount) {
        setBudgets({ ...budgets, [category]: parseFloat(amount) });
      }

      return (
        <div>
          <Navbar darkMode={darkMode} toggleDark={() => setDarkMode(!darkMode)} exportTx={exportToCSV} />
          <main className="p-4 space-y-4">
            <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
              <h2 className="font-semibold text-xl">Total Income: ‚Çπ{totalIncome.toFixed(2)}</h2>
              <label className="text-sm block mt-2">Manual Income (editable):</label>
              <input
                type="number"
                value={manualIncome}
                onChange={e => setManualIncome(parseFloat(e.target.value))}
                className="p-2 rounded bg-gray-100 dark:bg-gray-700 w-full mt-1"
              />
            </div>
            <TransactionForm onSubmit={addTransaction} />
            <TransactionTable transactions={transactions} onDelete={deleteTransaction} />
            <BudgetPlanner budgets={budgets} onUpdate={updateBudget} transactions={transactions} />
            <PieChart transactions={transactions} />
            <TimeSpentChart transactions={transactions} filter={filter} setFilter={setFilter} />
          </main>
<Footer />
        </div>
      );
    }

    const Navbar = ({ darkMode, toggleDark, exportTx, logoutUser, currentUser }) => (
      <nav className="sticky top-0 z-10 bg-white dark:bg-gray-800 p-4 shadow-md flex justify-between items-center">
        <div className="font-bold text-lg">MoneyWise</div>
        <div className="flex gap-3 items-center">
      <span className="text-sm">üë§ {currentUser}</span>
          <button onClick={exportTx} className="px-3 py-1 bg-green-600 text-white rounded">Export CSV</button>
          <button onClick={toggleDark} className="p-2 bg-gray-200 dark:bg-gray-700 rounded-full">
            {darkMode ? "üåô" : "‚òÄÔ∏è"}
          </button>
        <button onClick={logoutUser} className="px-2 py-1 bg-red-500 text-white rounded">Logout</button>
      </div>
      </nav>
    );

    const BudgetPlanner = ({ budgets, onUpdate, transactions }) => {
      const categories = [...new Set(transactions.map(t => t.category))].filter(cat => cat.toLowerCase() !== "income");

      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h2 className="font-semibold text-lg mb-2">Budget Planner</h2>
          {categories.map(cat => {
            const spent = transactions.filter(t => t.category === cat).reduce((sum, t) => sum + t.amount, 0);
            const budget = budgets[cat] || 0;
            return (
              <div key={cat} className="mb-3">
                <label className="block mb-1">{cat} Budget: ‚Çπ</label>
                <input type="number" className="p-1 rounded bg-gray-100 dark:bg-gray-700 w-full mb-1" value={budget} onChange={e => onUpdate(cat, e.target.value)} />
                <div className="w-full bg-gray-300 rounded h-2">
                  <div className="h-2 rounded bg-blue-500" style={{ width: `${Math.min(100, (spent/budget)*100)}%` }}></div>
                </div>
                <p className="text-sm">Spent ‚Çπ{spent.toFixed(2)} / ‚Çπ{budget}</p>
              </div>
            );
          })}
        </div>
      );
    };

    const PieChart = ({ transactions }) => {
      useEffect(() => {
        const ctx = document.getElementById("expensePie").getContext("2d");
        const categories = {};
        transactions.forEach(t => {
          if (t.category.toLowerCase() !== "income") {
            categories[t.category] = (categories[t.category] || 0) + t.amount;
          }
        });

        const chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(categories),
            datasets: [{
              data: Object.values(categories),
              backgroundColor: ["#4B7BEC", "#2E7D32", "#F9A825", "#e57373", "#ba68c8", "#64b5f6", "#FF8A65"]
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
          }
        });

        return () => chart.destroy();
      }, [transactions]);

      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h2 className="font-semibold text-lg mb-2">Expense Breakdown (Pie)</h2>
          <canvas id="expensePie"></canvas>
        </div>
      );
    };

    const TransactionForm = ({ onSubmit }) => {
      const [form, setForm] = useState({ date: "", description: "", category: "", amount: "", groupPay: "No", necessity: "Needs" });
      const handleChange = e => setForm({ ...form, [e.target.name]: e.target.value });
      const handleSubmit = e => {
        e.preventDefault();
        if (!form.date || !form.description || !form.category || form.amount <= 0) return alert("All fields required");
        onSubmit({ ...form, amount: parseFloat(form.amount) });
        setForm({ date: "", description: "", category: "", amount: "", groupPay: "No", necessity: "Needs" });
      };
      return (
        <form onSubmit={handleSubmit} className="bg-white dark:bg-gray-800 p-4 rounded shadow space-y-2">
          <h2 className="font-semibold text-lg mb-2">Add Transaction</h2>
          <input type="date" name="date" value={form.date} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700" required />
          <input type="text" name="description" placeholder="Description" value={form.description} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700" required />
          <select name="category" value={form.category} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700" required>
            <option value="">Select Category</option>
            {["Rent & Utilities","Foods & cravings","Daily Living","Travel & Transport","Fitness & Health","Family Support","Entertainment & Subscriptions","Personal Care & Shopping","Investments","Personal EMIs","Emergency Funds"].map(cat => (<option key={cat} value={cat}>{cat}</option>
            ))}
          </select>
          <input type="number" name="amount" placeholder="Amount" value={form.amount} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700" required />
          <select name="groupPay" value={form.groupPay} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700">
            <option value="No">Group Pay: No</option>
            <option value="Yes">Group Pay: Yes</option>
          </select>
          <select name="necessity" value={form.necessity} onChange={handleChange} className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700">
            <option value="Needs">Needs</option>
            <option value="Wants">Wants</option>
            <option value="Investment">Investment</option>
          </select>
          <button type="submit" className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Add</button>
        </form>
      );
    };

    const TransactionTable = ({ transactions, onDelete }) => (
      <div className="bg-white dark:bg-gray-800 p-4 rounded shadow overflow-auto">
        <h2 className="font-semibold text-lg mb-2">Transaction Log</h2>
        <table className="table-auto w-full text-left">
          <thead>
            <tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th></th></tr>
          </thead>
          <tbody>
            {transactions.map((tx, idx) => (
              <tr key={idx} className="border-t">
                <td>{tx.date}</td>
                <td>{tx.description}</td>
                <td>{tx.category}</td>
                <td className="text-green-600">‚Çπ{tx.amount.toFixed(2)}</td>
                <td><button onClick={() => onDelete(idx)} className="text-red-500">Delete</button></td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    );

    const TimeSpentChart = ({ transactions, filter, setFilter }) => {
      useEffect(() => {
        const ctx = document.getElementById("timespent").getContext("2d");
        const dailyTotals = {};
        const now = new Date();

        const filtered = transactions.filter(tx => {
          const txDate = new Date(tx.date);
          const diffTime = now - txDate;
          if (filter === "weekly") return diffTime <= 7 * 24 * 60 * 60 * 1000;
          if (filter === "monthly") return diffTime <= 30 * 24 * 60 * 60 * 1000;
          if (filter === "yearly") return diffTime <= 365 * 24 * 60 * 60 * 1000;
          return true;
        });

        filtered.forEach(tx => {
          const day = new Date(tx.date).toISOString().split("T")[0];
          dailyTotals[day] = (dailyTotals[day] || 0) + tx.amount;
        });

        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(dailyTotals),
            datasets: [{ label: 'Spending by Day', data: Object.values(dailyTotals), backgroundColor: '#F9A825' }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
          }
        });

        return () => chart.destroy();
      }, [transactions, filter]);

      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <div className="flex justify-between items-center mb-2">
            <h2 className="font-semibold text-lg">Time Spent Analysis</h2>
            <select value={filter} onChange={e => setFilter(e.target.value)} className="bg-gray-100 dark:bg-gray-700 p-1 rounded">
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
          <canvas id="timespent"></canvas>
        </div>
      );
    };

    

    function LoginForm({ onLogin }) {
      const [mode, setMode] = useState("email");
      const [input, setInput] = useState("");

      const validateInput = () => {
        if (mode === "email") {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(input);
        } else {
          return /^[a-zA-Z0-9]{3,20}$/.test(input);
        }
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!validateInput()) {
          alert("Invalid input format.");
          return;
        }
        localStorage.setItem("currentUser", input);
        onLogin(input);
      };

      return (
        <form onSubmit={handleSubmit} className="p-6 max-w-md mx-auto mt-10 bg-white dark:bg-gray-800 shadow rounded space-y-4">
          <h2 className="text-xl font-semibold">Login to MoneyWise</h2>
          <div className="flex gap-4">
            <label><input type="radio" checked={mode === "email"} onChange={() => setMode("email")} /> Email</label>
            <label><input type="radio" checked={mode === "username"} onChange={() => setMode("username")} /> Guest Username</label>
          </div>
          <input
            type="text"
            placeholder={mode === "email" ? "example@domain.com" : "Guest123"}
            value={input}
            onChange={(e) => setInput(e.target.value)}
            className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700"
            required
          />
          <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Log In</button>
        </form>
      );
    }

    const Footer = () => (
      <footer className="text-center text-sm py-4 bg-gray-200 dark:bg-gray-800 mt-4">
        <p>Connect on <a href="https://www.linkedin.com/in/subhra-prasad-chakraborty-3b91aa285?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" className="text-blue-500 underline">LinkedIn</a></p>
      </footer>
    );

const Root = () => {
  const [currentUser, setCurrentUser] = React.useState(() => localStorage.getItem("currentUser"));

  const logoutUser = () => {
    localStorage.removeItem("currentUser");
    setCurrentUser(null);
  };

  return currentUser ? <App currentUser={currentUser} logoutUser={logoutUser} /> : <LoginForm onLogin={setCurrentUser} />;
};

ReactDOM.render(<Root />, document.getElementById("root"));
</script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').then(
          (registration) => {
            console.log('Service Worker registered with scope:', registration.scope);
          },
          (error) => {
            console.log('Service Worker registration failed:', error);
          }
        );
      });
    }
  </script>
</body>
</html>
